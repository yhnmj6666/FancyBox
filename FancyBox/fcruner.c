/* This file was generated by the Hex-Rays decompiler version 7.7.0.220118.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

char *__thiscall FancyStrIsEmpty(FancyStr *this);
int __cdecl FancyBoxInitialize(HINSTANCE hInstance, int a2);
// void __usercall sub_401120(int@<eax>, int@<ecx>, HWND@<edi>, int);
// BOOL __usercall ToggleMaximizedWindow@<eax>(int@<eax>, HWND@<esi>);
LRESULT __stdcall WndProc(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
ATOM __cdecl MyRegisterClass(HINSTANCE hInstance);
int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd);
void __thiscall FancyStrDtor(FancyStr *this);
HWND __thiscall GetMostParentWindow(FancyBox *this);
char *GetLastErrorCStr();
HMODULE __thiscall FancyBoxFreeObjsys(FancyBox *this);
void __thiscall FancyBoxSaveCmdline(FancyBox *this, char *);
void __thiscall FancyBoxNotifyObjsys(FancyBox *this);
int FancyBoxErrorMessageBox(FancyBox *a1, LPCSTR a2, ...);
BYTE *__cdecl FancyRegReadString(LPCSTR lpString2, LPCSTR lpValueName, BYTE *lpDefault);
BOOL __cdecl FancyRegSetString(LPCSTR lpString2, LPCSTR lpValueName, LPCSTR);
// int __usercall sub_401D30@<eax>(CHAR *@<edi>, FancyStr *@<esi>, char *);
int FancyBoxHideAndErrorMessageBox(FancyBaseDialog *a1, HWND hWnd, LPCSTR a3, ...);
char *__thiscall sub_402090(FancyBox *this, unsigned int a2);
char *__thiscall sub_4021D0(FancyBox *this, unsigned int a2);
void __cdecl UpdateProgress(int, unsigned int);
CacheStore *__thiscall CacheStoreInitialize(CacheStore *this);
void __stdcall RemoveEmptyDirectoryRecursively(LPCSTR lpString2);
void __thiscall FancyBoxCtor(FancyBox *this);
void __thiscall sub_402900(FancyBox *this, FancyStr *a2);
int __thiscall FancyBoxUpdateSystem(FancyBox *this, HWND hWnd);
void __thiscall EnsureCache(CacheStore *this, char *a2);
int __thiscall InitializeCache(FancyBox *this); // idb
void __thiscall FancyBoxInitObjsys(FancyBox *this, HINSTANCE, HWND);
void __thiscall FancyDownloaderCallbackDtor(FancyDownloaderCallback *this);
int __stdcall IBindStatusCallback_AddRef(FancyDownloaderCallback *a1);
int __stdcall IBindStatusCallback_QueryInterface(FancyDownloaderCallback *, const void *, IUnknown **);
int __stdcall IHttpNegotiate_BeginningTransaction(int, int, int, int, int);
time_t __cdecl SystemTimeToTime_t(SYSTEMTIME SystemTime);
int __stdcall IBindStatusCallback_GetPriority(int, int);
int __stdcall IBindStatusCallback_OnObjectAvailable(int, int, int);
FancyDownloader *__thiscall FancyDownloaderCtor(FancyDownloader *this);
void __thiscall FancyDownloaderRelease(FancyDownloader *this);
void __thiscall FancyDownloaderAppendBuffer(FancyDownloader *this, const void *a2, unsigned int a3);
bool __thiscall FancyDownloaderHasCompleted(FancyDownloader *this, int contentLength, unsigned int lastModified);
int __thiscall FancyDownloaderWriteToFile(FancyDownloader *this);
int processWindowsMessages();
int __stdcall IHttpNegotiate_QueryInterface(int, const void *, IUnknown **);
int __stdcall IHttpNegotiate_AddRef(int);
int __stdcall IBindStatusCallback_Release(FancyDownloaderCallback *a1);
int __stdcall IHttpNegotiate_OnResponse(FancyDownloaderSubCallback *a1, DWORD a2, int a3, int a4, int a5);
void __thiscall FancyDownloaderDtor(FancyDownloader *this);
int __stdcall IHttpNegotiate_Release(FancyDownloaderCallback *a1);
int __stdcall IBindStatusCallback_OnStopBinding(FancyDownloaderCallback *, int, int);
void __thiscall FancyDownloaderOpen(FancyDownloader *this);
BOOL __cdecl sub_405230(char *, char *, int, int, void (__cdecl *)(int, unsigned int));
FancyBoxFileContent *__cdecl pfnopen(const char *pszFile);
UINT __cdecl pfnwrite(INT_PTR hf, void *pv, UINT cb); // idb
int __cdecl pfnclose();
int __cdecl pfnseek(FancyBoxFileContent *hf, int dist, int seektype);
void __thiscall FDISafeDestroy(void *this);
FancyCab *__thiscall FancyCabCtor(FancyCab *this);
void __thiscall FancyCabFree(FancyCab *this);
void __thiscall pfnfdinotifyCopyFileName(FancyCab *this, const char *a2);
int __cdecl pfnfdinotifyCopyFile(FDINOTIFICATION *a1);
INT_PTR __cdecl pfnfdinotify(int fdint, PFDINOTIFICATION pfdin);
void __thiscall FancyCabDtor(FancyCab *this);
int __thiscall FancyCabExtract(FancyCab *this, int a2);
FancyCab *__thiscall FancyCabDtor2(FancyCab *this, char);
int __thiscall FancyCabInitialize(FancyCab *this, FancyBoxFileContent *a2, FancyBoxFileContent *a3);
HLOCAL __cdecl sub_4059D0(DWORD a1);
FancyBaseDialog *__thiscall sub_405AB0(FancyBaseDialog *this);
void nullsub_1();
int __stdcall sub_405AE0(int, int, int, int);
BOOL __stdcall DialogFunc(HWND hWnd, UINT Msg, WPARAM wParam, unsigned int lParam);
char *FormatErrorMessage();
void __thiscall FancyUpdateDialogCreateInternal(FancyUpdateDialog *this, HINSTANCE hInstance, HWND hWndParent);
int __thiscall sub_405C70(FancyBaseDialog *this);
BOOL __thiscall FancyBoxHideOrDeactiveWindow(FancyBaseDialog *this, int a2);
void __thiscall FancyBaseDialogDtor(FancyBaseDialog *this);
FancyBaseDialog *__thiscall FancyBaseDialogRelease(FancyBaseDialog *this, char);
void __thiscall FancyUpdateDialogCtor(FancyUpdateDialog *this);
void __thiscall FancyUpdateDialogRelease(FancyUpdateDialog *this);
int __thiscall FancyUpdateDialogOnMessage(FancyUpdateDialog *this, HWND hWnd, UINT Msg, WPARAM wParam, unsigned int lParam);
void __thiscall FancyUpdateDialogInitAndShow(FancyUpdateDialog *this);
void __thiscall FancyUpdateDialogCreate(FancyUpdateDialog *this, HINSTANCE hInstance, HWND hWndParent, int);
BOOL __thiscall FancyBoxHideWindow(FancyBaseDialog *this);
void __thiscall FancyUpdateDialogSetDownloadingText(FancyUpdateDialog *this, LPCSTR lpString, int a3);
void __thiscall FancyUpdateDialogSetDownloadPercentage(FancyUpdateDialog *this, WPARAM wParam);
void __thiscall FancyUpdateDialogSetUpdatePercentage(FancyUpdateDialog *this, WPARAM wParam);
FancyUpdateDialog *__thiscall FancyUpdateDialogDtor(FancyUpdateDialog *this, char);
char *__cdecl TrimPath(const char *);
void __thiscall FancyBoxFileInitialize(FancyBoxFile *this);
void __cdecl FancyBoxChangeAndCreateDirectory(LPCSTR lpString2);
void __thiscall FancyBoxFileClose(FancyBoxFile *this);
int __thiscall FancyBoxFileRead(FancyBoxFile *this, LPVOID lpBuffer, int nNumberOfBytesToRead);
int __thiscall FancyBoxFileWrite(FancyBoxFile *this, LPCVOID lpBuffer, int nNumberOfBytesToWrite);
time_t __thiscall FileTimeToTime_t(FILETIME *lpFileTime);
BOOL __cdecl Time_tToFileTime(time_t, LPFILETIME lpFileTime);
BOOL __cdecl FancySetFileTime(LPCSTR lpFileName, time_t);
BOOL __cdecl VerifyFileSizeAndTime(LPCSTR lpFileName, unsigned int filetime, int filesize);
BOOL __cdecl CompareTime(LPCSTR lpFileName, int a2, int a3, FILETIME *a4);
time_t __cdecl GetLastWriteTime(LPCSTR lpFileName);
void __thiscall FancyBoxFileContentCtor(FancyBoxFileContent *this);
unsigned int __thiscall pfnreadInternal(FancyBoxFileContent *this, void *a2, unsigned int a3);
int __thiscall FancyBoxFileContentRead(FancyBoxFileContent *this, FancyBoxFile *a2);
unsigned int __thiscall pfnwriteInternal(FancyBoxFileContent *this, const void *a2, unsigned int a3);
BOOL __thiscall FancyBoxFileContentWrite(FancyBoxFileContent *this, FancyBoxFile *a2);
int __thiscall pfnseekInternal(FancyBoxFileContent *this, int a2, int a3);
void __cdecl GetPathAndFilenameFromCstr(FancyStr *, FancyStr *, char *);
void __thiscall FancyBoxFileDtor(FancyBoxFile *this);
int __thiscall FancyBoxFileOpen(FancyBoxFile *this, char *a2, unsigned int a3);
void __thiscall FancyBoxFileContentDtor(FancyBoxFileContent *this);
int InitialzeHexMap();
void __thiscall FancyStrCtor(FancyStr *this);
void __thiscall FancyStrSetCStr(FancyStr *this, const char *a2, int a3);
// char *__usercall find_cstr@<eax>(char *result@<eax>, char *a2@<edi>);
int __thiscall FancyStrFind(FancyStr *this, char *a2, int start);
signed int __thiscall FancyStrToLower(FancyStr *this);
void __thiscall FancyStrInsertCStrAt(FancyStr *this, int, const char *);
void __thiscall FancyStrInsert(FancyStr *this, int, char);
void __thiscall FancyStrAppend(FancyStr *this, FancyStr *a2);
void __thiscall FancyStrAppendCStr(FancyStr *this, const char *);
char __thiscall FancyStrCharAt(FancyStr *this, int a2);
BOOL __thiscall FancyStrEquals(FancyStr *this, const char *a2);
BOOL __thiscall FancyStrNotEquals(FancyStr *this, FancyStr *a2);
BOOL __thiscall FancyStrNotEqual(FancyStr *this, const char *a2);
void __thiscall FancyStrReplace(FancyStr *this, char *a2, const char *a3);
void __thiscall FancyStrRemove(FancyStr *this, int index, int size);
int __cdecl Cstr_to_int(char *);
void __thiscall FancyStrResize(FancyStr *this, int a2);
char *__thiscall FancyStrAlloc(FancyStr *this, int);
void __thiscall FancyStrShrink(FancyStr *this);
int __thiscall FancyStrTrimTailChar(FancyStr *this, char a2);
BOOL __thiscall FancyStrStartsWith(FancyStr *this, const char *a2);
FancyStr *__thiscall FancyStrSetStr(FancyStr *this, const char **);
void __thiscall FancyStrCtorFromCStr(FancyStr *this, char *a2);
void FancyStrSetVAStr(FancyStr *, LPCSTR arg4, ...);
void __thiscall FancyStrSet(FancyStr *this, const char **);
void __thiscall FancyStrFromCStr(FancyStr *this, char *);
int __thiscall FancyStrSubstring(FancyStr *this, FancyStr *a2, char separator, char a4, int a5);
int __thiscall FancyStrGetInteger(FancyStr *this, int nDefault, char separator);
FancyStr *__thiscall FancyStrSubString(FancyStr *this, FancyStr *a2, int a3, int a4);
FancyLinedText *__thiscall FancyLinedTextCtor(FancyLinedText *this);
void __thiscall FancyLinedTextAddLine(FancyLinedText *this, const char *a2);
void __thiscall FancyLinedTextClear(FancyLinedText *this);
char *__thiscall FancyLinedTextGetLine(FancyLinedText *this, int);
int __thiscall FancyLinedTextSize(FancyLinedText *this);
void __thiscall FancyLinedTextFillFromBuffer(FancyLinedText *this, char *a2);
void __thiscall FancyLinedTextDtor(FancyLinedText *this);
int __thiscall FancyLinedTextFillFromPath(FancyLinedText *this, char *a1);
FancyLinedText *__thiscall FancyLinedTextRelease(FancyLinedText *this, char a2);
// int __cdecl atexit(void (__cdecl *)());
void __cdecl j__free(void *);
// int __cdecl rand();
// void __stdcall __ArrayUnwind(void *, unsigned int, int, void (__thiscall *)(void *)); idb
void __stdcall vector_destructor(char *a1, unsigned int a2, int a3, void (__thiscall *a4)(void *));
void __stdcall vector_constructor(char *, unsigned int, int, void (__thiscall *)(void *), void (__thiscall *)(void *));
// void *__cdecl operator new(SIZE_T dwBytes); idb
// time_t __cdecl mktime(struct tm *);
// char *__cdecl strncpy(char *, const char *, size_t);
// char *__cdecl strrchr(const char *, int);
// size_t __cdecl wcslen(const wchar_t *);
// struct tm *__cdecl localtime(const time_t *);
// void *__cdecl memcpy(void *, const void *, size_t);
// void __cdecl __noreturn _exit(int);
// void __noreturn sub_40A1D5();
// void __noreturn sub_40A202();
// int __cdecl fflush(FILE *);
// int __cdecl flsall(int a1);
// int sub_40A6CC();
// int __cdecl _NMSG_WRITE(DWORD NumberOfBytesWritten); idb
// int __cdecl _isctype(int, int);
// int __cdecl sub_40DF3E(int, int);
// int __cdecl sub_40DF91(int, int);
// int __cdecl raise(int);
// _DWORD __cdecl __mtold12(_DWORD, _DWORD, _DWORD); weak
// int __cdecl __strgtold12(int a1, char **a2, char *a3, int a4, int a5, int a6, int a7);
// _DWORD __cdecl __multtenpow12(_DWORD, _DWORD, _DWORD); weak
// HRESULT __stdcall CreateAsyncBindCtx(DWORD reserved, IBindStatusCallback *pBSCb, IEnumFORMATETC *pEFetc, IBindCtx **ppBC);
// HRESULT __stdcall CreateURLMoniker(LPMONIKER pMkCtx, LPCWSTR szURL, LPMONIKER *ppmk);
// int __cdecl _strnicmp(const char *, const char *, size_t);
int sub_411550();
int sub_411570();
void __cdecl sub_411590(); // idb
void __cdecl sub_4115A0(); // idb
// LSTATUS __stdcall RegCreateKeyExA(HKEY hKey, LPCSTR lpSubKey, DWORD Reserved, LPSTR lpClass, DWORD dwOptions, REGSAM samDesired, const LPSECURITY_ATTRIBUTES lpSecurityAttributes, PHKEY phkResult, LPDWORD lpdwDisposition);
// LSTATUS __stdcall RegSetValueExA(HKEY hKey, LPCSTR lpValueName, DWORD Reserved, DWORD dwType, const BYTE *lpData, DWORD cbData);
// LSTATUS __stdcall RegOpenKeyA(HKEY hKey, LPCSTR lpSubKey, PHKEY phkResult);
// LSTATUS __stdcall RegQueryValueExA(HKEY hKey, LPCSTR lpValueName, LPDWORD lpReserved, LPDWORD lpType, LPBYTE lpData, LPDWORD lpcbData);
// void __stdcall InitCommonControls();
// int __stdcall MultiByteToWideChar(UINT CodePage, DWORD dwFlags, LPCSTR lpMultiByteStr, int cbMultiByte, LPWSTR lpWideCharStr, int cchWideChar);
// BOOL __stdcall DeleteFileA(LPCSTR lpFileName);
// BOOL __stdcall SetCurrentDirectoryA(LPCSTR lpPathName);
// DWORD __stdcall GetCurrentDirectoryA(DWORD nBufferLength, LPSTR lpBuffer);
// BOOL __stdcall RemoveDirectoryA(LPCSTR lpPathName);
// BOOL __stdcall FindClose(HANDLE hFindFile);
// HANDLE __stdcall FindFirstFileA(LPCSTR lpFileName, LPWIN32_FIND_DATAA lpFindFileData);
// void __stdcall Sleep(DWORD dwMilliseconds);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// BOOL __stdcall CopyFileA(LPCSTR lpExistingFileName, LPCSTR lpNewFileName, BOOL bFailIfExists);
// BOOL __stdcall FileTimeToSystemTime(const FILETIME *lpFileTime, LPSYSTEMTIME lpSystemTime);
// BOOL __stdcall FileTimeToLocalFileTime(const FILETIME *lpFileTime, LPFILETIME lpLocalFileTime);
// BOOL __stdcall SystemTimeToFileTime(const SYSTEMTIME *lpSystemTime, LPFILETIME lpFileTime);
// BOOL __stdcall LocalUnlock(HLOCAL hMem);
// LPVOID __stdcall LocalLock(HLOCAL hMem);
// HLOCAL __stdcall LocalAlloc(UINT uFlags, SIZE_T uBytes);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// BOOL __stdcall ReadFile(HANDLE hFile, LPVOID lpBuffer, DWORD nNumberOfBytesToRead, LPDWORD lpNumberOfBytesRead, LPOVERLAPPED lpOverlapped);
// BOOL __stdcall WriteFile(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// BOOL __stdcall LocalFileTimeToFileTime(const FILETIME *lpLocalFileTime, LPFILETIME lpFileTime);
// BOOL __stdcall SetFileTime(HANDLE hFile, const FILETIME *lpCreationTime, const FILETIME *lpLastAccessTime, const FILETIME *lpLastWriteTime);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// LPSTR __stdcall lstrcpyA(LPSTR lpString1, LPCSTR lpString2);
// LPSTR __stdcall lstrcatA(LPSTR lpString1, LPCSTR lpString2);
// BOOL __stdcall FreeLibrary(HMODULE hLibModule);
// DWORD __stdcall GetLastError();
// DWORD __stdcall FormatMessageA(DWORD dwFlags, LPCVOID lpSource, DWORD dwMessageId, DWORD dwLanguageId, LPSTR lpBuffer, DWORD nSize, va_list *Arguments);
// HLOCAL __stdcall LocalFree(HLOCAL hMem);
// DWORD __stdcall GetModuleFileNameA(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// BOOL __stdcall ShowWindow(HWND hWnd, int nCmdShow);
// HWND __stdcall CreateWindowExA(DWORD dwExStyle, LPCSTR lpClassName, LPCSTR lpWindowName, DWORD dwStyle, int X, int Y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam);
// UINT_PTR __stdcall SetTimer(HWND hWnd, UINT_PTR nIDEvent, UINT uElapse, TIMERPROC lpTimerFunc);
// BOOL __stdcall UpdateWindow(HWND hWnd);
// BOOL __stdcall IsWindow(HWND hWnd);
// DWORD __stdcall CharLowerBuffA(LPSTR lpsz, DWORD cchLength);
// BOOL __stdcall MoveWindow(HWND hWnd, int X, int Y, int nWidth, int nHeight, BOOL bRepaint);
// BOOL __stdcall GetClientRect(HWND hWnd, LPRECT lpRect);
// BOOL __stdcall SetWindowTextA(HWND hWnd, LPCSTR lpString);
// LRESULT __stdcall SendMessageA(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// HWND __stdcall CreateDialogParamA(HINSTANCE hInstance, LPCSTR lpTemplateName, HWND hWndParent, DLGPROC lpDialogFunc, LPARAM dwInitParam);
// HWND __stdcall CreateDialogIndirectParamA(HINSTANCE hInstance, LPCDLGTEMPLATEA lpTemplate, HWND hWndParent, DLGPROC lpDialogFunc, LPARAM dwInitParam);
// BOOL __stdcall PeekMessageA(LPMSG lpMsg, HWND hWnd, UINT wMsgFilterMin, UINT wMsgFilterMax, UINT wRemoveMsg);
// BOOL __stdcall PostMessageA(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// int __stdcall wvsprintfA(LPSTR, LPCSTR, va_list arglist);
// int __stdcall MessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType);
// HWND __stdcall GetDlgItem(HWND hDlg, int nIDDlgItem);
// HWND __stdcall GetParent(HWND hWnd);
// BOOL __stdcall GetMessageA(LPMSG lpMsg, HWND hWnd, UINT wMsgFilterMin, UINT wMsgFilterMax);
// LRESULT __stdcall DispatchMessageA(const MSG *lpMsg);
// BOOL __stdcall TranslateMessage(const MSG *lpMsg);
// int __stdcall LoadStringA(HINSTANCE hInstance, UINT uID, LPSTR lpBuffer, int cchBufferMax);
// void __stdcall PostQuitMessage(int nExitCode);
// LRESULT __stdcall DefWindowProcA(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// BOOL __stdcall KillTimer(HWND hWnd, UINT_PTR uIDEvent);
// BOOL __stdcall DestroyWindow(HWND hWnd);
// LONG __stdcall GetWindowLongA(HWND hWnd, int nIndex);
// LONG __stdcall SetWindowLongA(HWND hWnd, int nIndex, LONG dwNewLong);
// BOOL __stdcall SetWindowPos(HWND hWnd, HWND hWndInsertAfter, int X, int Y, int cx, int cy, UINT uFlags);
// int __stdcall GetSystemMetrics(int nIndex);

//-------------------------------------------------------------------------
// Data declarations

char emptyString0[2] = { '\0', '\0' }; // weak
IHttpNegotiateVtbl stru_412570 =
{
  &IHttpNegotiate_QueryInterface,
  &IHttpNegotiate_AddRef,
  &IHttpNegotiate_Release,
  &IHttpNegotiate_BeginningTransaction,
  &IHttpNegotiate_OnResponse
};
IBindStatusCallbackVtbl stru_412584 =
{
  &IBindStatusCallback_QueryInterface,
  &IBindStatusCallback_AddRef,
  &IBindStatusCallback_Release,
  &IBindStatusCallback_OnStartBinding,
  &IBindStatusCallback_GetPriority,
  &IBindStatusCallback_GetPriority,
  &IBindStatusCallback_OnProgress,
  &IBindStatusCallback_OnStopBinding,
  &IBindStatusCallback_GetBindInfo,
  &IBindStatusCallback_OnDataAvailable,
  &IBindStatusCallback_OnObjectAvailable
};
int (__thiscall *off_4125F4)(void *, char) = &FancyCabDtor2; // weak
FancyBaseDialogVtbl stru_412618 = { &nullsub_1, &sub_405C70, &nullsub_2, &FancyBaseDialogRelease, &sub_405AE0 }; // weak
FancyBaseDialogVtbl stru_41263C =
{
  &FancyUpdateDialogInitAndShow,
  &sub_405EE0,
  &nullsub_2,
  &FancyUpdateDialogDtor,
  &FancyUpdateDialogOnMessage
}; // weak
int (__thiscall *off_412660)(void *, char) = &FancyLinedTextRelease; // weak
IID CLSID_IStream = { 12u, 0u, 0u, { 192u, 0u, 0u, 0u, 0u, 0u, 0u, 70u } };
GUID CLSID_IWinInetHttpInfo = { 2045430232u, 47866u, 4558u, { 140u, 130u, 0u, 170u, 0u, 75u, 169u, 11u } }; // weak
char aObjsysDll[11] = "objsys.dll"; // weak
char aFc2infoDat[12] = "fc2info.dat"; // weak
char aFcrunerExe[] = "fcruner.exe"; // idb
char *emptyString = &emptyString0;
int nCmdShow = 0; // idb
CHAR Buffer[100] =
{
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0'
}; // idb
HINSTANCE hInstance = NULL; // idb
FancyBox fancyBox =
{
  NULL,
  NULL,
  NULL,
  NULL,
  NULL,
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  0,
  0,
  0,
  0,
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  { NULL, 0, 0 },
  '\0',
  {
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    
  }
};
char byte_416978[]; // weak
BYTE Data; // idb
char byte_417178[32]; // weak
char byte_417198[32]; // weak
int dword_4171B8; // weak
FancyBoxFileContent *dword_4181CC;
FancyBoxFileContent *dword_4181D0;
BOOL (__cdecl *FDICopy)(HFDI hfdi, LPSTR pszCabinet, LPSTR pszCabPath, int flags, PFNFDINOTIFY pfnfdin, PFNFDIDECRYPT pfnfdid, void *pvUser); // idb
int (__cdecl *FDIDestroy)(_DWORD); // weak
HMODULE hLibModule; // idb
FancyCab *dword_4181E8;
char byte_4181F0[]; // weak
char byte_4185F0[264]; // weak
int dword_4186F8[256]; // weak
char byte_418AF8[16]; // weak


//----- (00401000) --------------------------------------------------------
char *__thiscall FancyStrIsEmpty(FancyStr *this)
{
  char *result; // eax

  if ( this->len < 1 )
    return emptyString;
  result = this->buffer;
  if ( !this->buffer )
    return emptyString;
  return result;
}

//----- (00401020) --------------------------------------------------------
int __cdecl FancyBoxInitialize(HINSTANCE hInstance, int a2)
{
  int v2; // esi
  int SystemMetrics; // eax
  int result; // eax
  HWND v5; // esi
  CHAR Filename[512]; // [esp+Ch] [ebp-200h] BYREF

  InitCommonControls();
  ::hInstance = hInstance;
  v2 = (GetSystemMetrics(0) - 800) / 2;
  SystemMetrics = GetSystemMetrics(1);
  result = (int)CreateWindowExA(
                  0,
                  Buffer,
                  "FcBox II",
                  0xCF0000u,
                  v2,
                  (SystemMetrics - 600) / 2,
                  800,
                  600,
                  0,
                  0,
                  hInstance,
                  0);
  v5 = (HWND)result;
  if ( result )
  {
    fancyBox.field_74 = 3;
    GetModuleFileNameA(hInstance, Filename, 0x200u);
    FancyRegSetString("fcbox2", "runerpath", Filename);
    FancyBoxInitObjsys(&fancyBox, hInstance, v5);
    nCmdShow = a2;
    ShowWindow(v5, 0);
    SetTimer(v5, 0x3E8u, 0x64u, 0);
    UpdateWindow(v5);
    return 1;
  }
  return result;
}

//----- (00401120) --------------------------------------------------------
void __usercall sub_401120(int a1@<eax>, int a2@<ecx>, HWND a3@<edi>, int a4)
{
  LONG WindowLongA; // eax
  int v7; // esi

  WindowLongA = GetWindowLongA(a3, -16);
  v7 = a4 | WindowLongA & ~a2;
  if ( WindowLongA != v7 )
  {
    SetWindowLongA(a3, -16, v7);
    if ( a1 )
      SetWindowPos(a3, 0, 0, 0, 0, 0, a1 | 0x17);
  }
}

//----- (00401170) --------------------------------------------------------
BOOL __usercall ToggleMaximizedWindow@<eax>(int a1@<eax>, HWND a2@<esi>)
{
  LONG WindowLongA; // eax
  LONG v3; // eax
  LONG v5; // eax
  LONG v6; // eax

  if ( a1 )
  {
    WindowLongA = GetWindowLongA(a2, -16);
    if ( WindowLongA != (WindowLongA & 0xFF3FFFFF) )
      SetWindowLongA(a2, -16, WindowLongA & 0xFF3FFFFF);
    v3 = GetWindowLongA(a2, -16);
    if ( v3 != (v3 & 0xFFFBFFFF) )
    {
      SetWindowLongA(a2, -16, v3 & 0xFFFBFFFF);
      SetWindowPos(a2, 0, 0, 0, 0, 0, 0x17u);
    }
    return ShowWindow(a2, 3);
  }
  else
  {
    v5 = GetWindowLongA(a2, -16);
    if ( v5 != (v5 | 0xC00000) )
      SetWindowLongA(a2, -16, v5 | 0xC00000);
    v6 = GetWindowLongA(a2, -16);
    if ( v6 != (v6 | 0x40000) )
      SetWindowLongA(a2, -16, v6 | 0x40000);
    return ShowWindow(a2, 9);
  }
}

//----- (00401210) --------------------------------------------------------
LRESULT __stdcall WndProc(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
{
  LRESULT result; // eax
  LONG WindowLongA; // eax
  LONG v6; // eax
  char Buffer[100]; // [esp+8h] [ebp-64h] BYREF

  LoadStringA(hInstance, 0x6Au, Buffer, 100);
  if ( Msg <= 0x14 )
  {
    switch ( Msg )
    {
      case 0x14u:
        if ( !fancyBox.objsysReady )
          return DefWindowProcA(hWnd, 0x14u, wParam, lParam);
        return 0;
      case 2u:
        PostQuitMessage(0);
        return 0;
      case 5u:
        nullsub_1();
        return 0;
      case 6u:
        if ( wParam )
        {
          FancyBoxNotifyObjsys(&fancyBox);
          return 0;
        }
        return 0;
    }
    return DefWindowProcA(hWnd, Msg, wParam, lParam);
  }
  if ( Msg == 273 )
  {
    if ( (_WORD)wParam != 105 )
      return DefWindowProcA(hWnd, 0x111u, wParam, lParam);
    DestroyWindow(hWnd);
    return 0;
  }
  if ( Msg == 275 )
  {
    ShowWindow(hWnd, nCmdShow);
    KillTimer(hWnd, 1000u);
    return 0;
  }
  if ( Msg != 3024 )
    return DefWindowProcA(hWnd, Msg, wParam, lParam);
  switch ( wParam )
  {
    case 0u:
      ToggleMaximizedWindow(1, hWnd);
      result = 0;
      break;
    case 1u:
      ToggleMaximizedWindow(0, hWnd);
      result = 0;
      break;
    case 2u:
      WindowLongA = GetWindowLongA(hWnd, -16);
      if ( WindowLongA != (WindowLongA & 0xFFFBFFFF) )
        SetWindowLongA(hWnd, -16, WindowLongA & 0xFFFBFFFF);
      sub_401120(32, 0xC00000, hWnd, 0);
      result = 0;
      break;
    case 3u:
      v6 = GetWindowLongA(hWnd, -16);
      if ( v6 != (v6 | 0x40000) )
        SetWindowLongA(hWnd, -16, v6 | 0x40000);
      sub_401120(32, 0, hWnd, 0xC00000);
      result = 0;
      break;
    default:
      return 0;
  }
  return result;
}
// 401210: using guessed type CHAR Buffer[100];

//----- (00401440) --------------------------------------------------------
ATOM __cdecl MyRegisterClass(HINSTANCE hInstance)
{
  char *buffer; // eax
  HICON (__stdcall *v2)(HINSTANCE, LPCSTR); // esi
  WNDCLASSEXA v4; // [esp+8h] [ebp-30h] BYREF

  v4.cbSize = 48;
  v4.style = 3;
  v4.lpfnWndProc = WndProc;
  v4.cbClsExtra = 0;
  v4.cbWndExtra = 0;
  v4.hInstance = hInstance;
  if ( fancyBox.strCommandI.len <= 0 )
  {
    v2 = LoadIconA;
LABEL_8:
    v4.hIcon = v2(hInstance, (LPCSTR)0x6B);
    goto LABEL_9;
  }
  if ( fancyBox.strCommandI.len < 1 || (buffer = fancyBox.strCommandI.buffer) == 0 )
    buffer = *(char **)emptyString;
  v2 = LoadIconA;
  v4.hIcon = LoadIconA(hInstance, buffer);
  if ( !v4.hIcon )
    goto LABEL_8;
LABEL_9:
  v4.hCursor = LoadCursorA(0, (LPCSTR)0x7F00);
  v4.hbrBackground = (HBRUSH)6;
  v4.lpszMenuName = 0;
  v4.lpszClassName = Buffer;
  v4.hIconSm = v2(v4.hInstance, (LPCSTR)0x6C);
  return RegisterClassExA(&v4);
}

//----- (00401500) --------------------------------------------------------
int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
{
  int result; // eax
  struct tagMSG Msg; // [esp+0h] [ebp-1Ch] BYREF

  fancyBox.field_A8 = 1;
  if ( *lpCmdLine )
    FancyBoxSaveCmdline(&fancyBox, lpCmdLine);
  LoadStringA(hInstance, 0x6Du, Buffer, 100);
  MyRegisterClass(hInstance);
  result = FancyBoxInitialize(hInstance, nShowCmd);
  if ( result )
  {
    while ( GetMessageA(&Msg, 0, 0, 0) )
    {
      TranslateMessage(&Msg);
      DispatchMessageA(&Msg);
    }
    FancyBoxFreeObjsys(&fancyBox);
    return Msg.wParam;
  }
  return result;
}

//----- (004015B0) --------------------------------------------------------
void __thiscall FancyStrDtor(FancyStr *this)
{
  if ( this->buffer )
    j__free(this->buffer);
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
}

//----- (004016C0) --------------------------------------------------------
HWND __thiscall GetMostParentWindow(FancyBox *this)
{
  HWND result; // eax
  HWND hWnd; // esi
  HWND i; // eax

  result = (HWND)IsWindow(this->hWnd);
  if ( result )
  {
    hWnd = this->hWnd;
    for ( i = GetParent(hWnd); i; i = GetParent(i) )
      hWnd = i;
    return hWnd;
  }
  return result;
}

//----- (00401780) --------------------------------------------------------
char *GetLastErrorCStr()
{
  DWORD LastError; // eax
  char *v1; // esi
  char *v2; // eax
  char *v3; // edx
  char v4; // cl
  CHAR Buffer[4]; // [esp+0h] [ebp-4h] BYREF

  LastError = GetLastError();
  if ( FormatMessageA(0x1300u, 0, LastError, 0x400u, Buffer, 0, 0) )// FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS | FORMAT_MESSAGE_ALLOCATE_BUFFER
  {
    v1 = *(char **)Buffer;
    v2 = *(char **)Buffer;
    v3 = &byte_416978[-*(_DWORD *)Buffer];
    do
    {
      v4 = *v2;
      v2[(_DWORD)v3] = *v2;
      ++v2;
    }
    while ( v4 );
    LocalFree(v1);
    return byte_416978;
  }
  else
  {
    byte_416978[0] = 0;
    return byte_416978;
  }
}

//----- (004017E0) --------------------------------------------------------
HMODULE __thiscall FancyBoxFreeObjsys(FancyBox *this)
{
  void (__cdecl *fStdCmdFancyBox)(int, char *); // eax
  HMODULE result; // eax

  fStdCmdFancyBox = this->fStdCmdFancyBox;
  if ( fStdCmdFancyBox )
    fStdCmdFancyBox(3, 0);
  result = this->hObjsys;
  if ( this->hObjsys )
    result = (HMODULE)FreeLibrary(this->hObjsys);
  this->fStdCmdFancyBox = 0;
  this->hObjsys = 0;
  this->objsysReady = 0;
  return result;
}

//----- (00401820) --------------------------------------------------------
void __thiscall FancyBoxSaveCmdline(FancyBox *this, char *a2)
{
  char *v3; // eax
  char v4; // al
  char *v5; // eax
  FancyStr *p_strCommandC; // esi
  char *v7; // eax
  bool v8; // cc
  char *v9; // eax
  char *v10; // eax
  unsigned int v11; // esi
  int v12; // eax
  char *v13; // ecx
  unsigned int v14; // esi
  int v15; // eax
  char *v16; // ecx
  char *buffer; // eax
  FancyStr v18; // [esp+Ch] [ebp-24h] BYREF
  FancyStr v19; // [esp+18h] [ebp-18h] BYREF
  int v20; // [esp+2Ch] [ebp-4h]

  FancyStrFromCStr(&this->cmdLine, a2);
  FancyStrCtor(&v19);
  v20 = 0;
  FancyStrCtor(&v18);
  LOBYTE(v20) = 1;
  FancyStrFromCStr(&v19, a2);
  if ( this->strCommandRaw.buffer )
    j__free(this->strCommandRaw.buffer);
  this->strCommandRaw.buffer = 0;
  this->strCommandRaw.len = 0;
  this->strCommandRaw.capacity = 0;
  while ( FancyStrSubstring(&v19, &v18, ' ', 0, 0) )
  {
    if ( v18.len > 3 )
    {
      if ( FancyStrCharAt(&v18, 0) == '-' )
      {
        switch ( FancyStrCharAt(&v18, 1) )
        {
          case 'C':
          case 'c':
            if ( v18.len < 1 || (buffer = v18.buffer) == 0 )
              buffer = emptyString;
            p_strCommandC = &this->strCommandC;
            v7 = buffer + 3;
            goto LABEL_18;
          case 'D':
          case 'd':
            if ( v18.len < 1 || (v3 = v18.buffer) == 0 )
              v3 = emptyString;
            FancyStrFromCStr(&this->strCommandDll, v3 + 3);
            break;
          case 'F':
          case 'f':
            v14 = FancyStrCharAt(&v18, 2) - '1';
            if ( v14 <= 2 )
            {
              v15 = this->field_CB8[v14];
              if ( v15 < 16 )
              {
                if ( v18.len < 1 || (v16 = v18.buffer) == 0 )
                  v16 = emptyString;
                strcpy((char *)&this->field_6A8 + 512 * v14 + 32 * v15 + 1, v16 + 4);
                ++this->field_CB8[v14];
              }
            }
            break;
          case 'I':
          case 'i':
            if ( v18.len < 1 || (v10 = v18.buffer) == 0 )
              v10 = emptyString;
            FancyStrFromCStr(&this->strCommandI, v10 + 3);
            break;
          case 'S':
          case 's':
            v4 = FancyStrCharAt(&v18, 2);
            if ( v4 == ':' )
            {
              v8 = v18.len < 1;
              this->field_68 = 1;
              if ( v8 || (v9 = v18.buffer) == 0 )
                v9 = emptyString;
              FancyStrFromCStr(&this->strCommandSystem, v9 + 3);
              FancyStrTrimTailChar(&this->strCommandSystem, '/');
              FancyStrAppendCStr(&this->strCommandSystem, "/");
            }
            else if ( (v4 == 'V' || v4 == 'v') && v18.len > 4 )
            {
              v5 = v18.buffer;
              if ( !v18.buffer )
                v5 = emptyString;
              p_strCommandC = &this->strCommandSV;
              v7 = v5 + 4;
LABEL_18:
              FancyStrFromCStr(p_strCommandC, v7);
              FancyStrTrimTailChar(p_strCommandC, '\\');
            }
            break;
          case 'W':
          case 'w':
            v11 = FancyStrCharAt(&v18, 2) - '1';
            if ( v11 <= 2 )
            {
              v12 = this->field_CAC[v11];
              if ( v12 < 16 )
              {
                if ( v18.len < 1 || (v13 = v18.buffer) == 0 )
                  v13 = emptyString;
                strcpy(&this->field_A8 + 512 * v11 + 32 * v12 + 1, v13 + 4);
                ++this->field_CAC[v11];
              }
            }
            break;
          default:
            break;
        }
      }
      else
      {
        if ( this->strCommandRaw.len > 0 )
          FancyStrAppendCStr(&this->strCommandRaw, ",");
        FancyStrAppend(&this->strCommandRaw, &v18);
      }
    }
  }
  LOBYTE(v20) = 0;
  FancyStrDtor(&v18);
  v20 = -1;
  FancyStrDtor(&v19);
}
// 40193C: conditional instruction was optimized away because %var_20.4>=5

//----- (00401B90) --------------------------------------------------------
void __thiscall FancyBoxNotifyObjsys(FancyBox *this)
{
  void (__cdecl *fStdCmdFancyBox)(int, char *); // eax

  fStdCmdFancyBox = this->fStdCmdFancyBox;
  if ( fStdCmdFancyBox )
    fStdCmdFancyBox(10, 0);
}

//----- (00401BB0) --------------------------------------------------------
int FancyBoxErrorMessageBox(FancyBox *a1, LPCSTR a2, ...)
{
  CHAR Text[2048]; // [esp+0h] [ebp-800h] BYREF
  va_list arglist; // [esp+80Ch] [ebp+Ch] BYREF

  va_start(arglist, a2);
  wvsprintfA(Text, a2, arglist);
  return MessageBoxA(a1->hWnd, Text, "FancyBox Err", 0x10u);
}

//----- (00401C00) --------------------------------------------------------
BYTE *__cdecl FancyRegReadString(LPCSTR lpString2, LPCSTR lpValueName, BYTE *lpDefault)
{
  BYTE *result; // eax
  bool v4; // zf
  DWORD cbData; // [esp+0h] [ebp-Ch] BYREF
  HKEY phkResult; // [esp+4h] [ebp-8h] BYREF
  DWORD Type; // [esp+8h] [ebp-4h] BYREF

  lstrcpyA((LPSTR)&Data, "SOFTWARE\\XXT\\");
  lstrcatA((LPSTR)&Data, lpString2);
  if ( RegOpenKeyA(HKEY_LOCAL_MACHINE, (LPCSTR)&Data, &phkResult) )
    return lpDefault;
  cbData = 1024;
  v4 = RegQueryValueExA(phkResult, lpValueName, 0, &Type, &Data, &cbData) == 0;
  result = lpDefault;
  if ( v4 )
    return &Data;
  return result;
}

//----- (00401C80) --------------------------------------------------------
BOOL __cdecl FancyRegSetString(LPCSTR lpString2, LPCSTR lpValueName, LPCSTR a3)
{
  HKEY phkResult; // [esp+0h] [ebp-408h] BYREF
  DWORD dwDisposition; // [esp+4h] [ebp-404h] BYREF
  CHAR String1[1024]; // [esp+8h] [ebp-400h] BYREF

  lstrcpyA(String1, "SOFTWARE\\XXT\\");
  lstrcatA(String1, lpString2);
  RegCreateKeyExA(HKEY_LOCAL_MACHINE, String1, 0, 0, 0, 0x20006u, 0, &phkResult, &dwDisposition);
  lstrcpyA(String1, a3);
  return RegSetValueExA(phkResult, lpValueName, 0, 1u, (const BYTE *)String1, strlen(String1)) == 0;
}

//----- (00401D30) --------------------------------------------------------
int __usercall sub_401D30@<eax>(CHAR *a1@<edi>, FancyStr *a2@<esi>, char *a3)
{
  FancyBoxFile file; // [esp+4h] [ebp-368h] BYREF
  FancyBoxFileContent v5; // [esp+18h] [ebp-354h] BYREF
  FancyBoxFileContent v6; // [esp+2Ch] [ebp-340h] BYREF
  FancyCab v7; // [esp+40h] [ebp-32Ch] BYREF
  int v8; // [esp+368h] [ebp-4h]

  FancyBoxFileInitialize(&file);
  v8 = 0;
  FancyBoxFileContentCtor(&v5);
  LOBYTE(v8) = 1;
  FancyBoxFileContentCtor(&v6);
  LOBYTE(v8) = 2;
  if ( !FancyBoxFileOpen(&file, a3, 0) || !FancyBoxFileContentRead(&v5, &file) )
    goto LABEL_12;
  FancyBoxFileClose(&file);
  v5.readSize = 0;
  FancyCabCtor(&v7);
  LOBYTE(v8) = 3;
  if ( !FancyCabInitialize(&v7, &v5, &v6) )
  {
    FancyStrFromCStr(a2, "Can't open file");
    LOBYTE(v8) = 2;
    FancyCabDtor(&v7);
    LOBYTE(v8) = 1;
    FancyBoxFileContentDtor(&v6);
    LOBYTE(v8) = 0;
    FancyBoxFileContentDtor(&v5);
    v8 = -1;
    FancyBoxFileDtor(&file);
    return 0;
  }
  if ( !FancyCabExtract(&v7, 0) )
  {
    FancyStrFromCStr(a2, "Can't extract file");
    LOBYTE(v8) = 2;
    FancyCabDtor(&v7);
    LOBYTE(v8) = 1;
    FancyBoxFileContentDtor(&v6);
    LOBYTE(v8) = 0;
    FancyBoxFileContentDtor(&v5);
    v8 = -1;
    FancyBoxFileDtor(&file);
    return 0;
  }
  if ( VerifyFileSizeAndTime(a1, 0, 0) && !DeleteFileA(a1) )
  {
    FancyStrFromCStr(a2, "Can't over write file");
    LOBYTE(v8) = 2;
    FancyCabDtor(&v7);
    LOBYTE(v8) = 1;
    FancyBoxFileContentDtor(&v6);
    LOBYTE(v8) = 0;
    FancyBoxFileContentDtor(&v5);
    v8 = -1;
    FancyBoxFileDtor(&file);
    return 0;
  }
  if ( !FancyBoxFileOpen(&file, a1, 1u) )
  {
    FancyStrFromCStr(a2, "Can't create file");
    LOBYTE(v8) = 2;
    FancyCabDtor(&v7);
LABEL_12:
    LOBYTE(v8) = 1;
    FancyBoxFileContentDtor(&v6);
    LOBYTE(v8) = 0;
    FancyBoxFileContentDtor(&v5);
    v8 = -1;
    FancyBoxFileDtor(&file);
    return 0;
  }
  FancyBoxFileContentWrite(&v6, &file);
  FancyBoxFileClose(&file);
  LOBYTE(v8) = 2;
  FancyCabDtor(&v7);
  LOBYTE(v8) = 1;
  FancyBoxFileContentDtor(&v6);
  LOBYTE(v8) = 0;
  FancyBoxFileContentDtor(&v5);
  v8 = -1;
  FancyBoxFileDtor(&file);
  return 1;
}

//----- (00402040) --------------------------------------------------------
int FancyBoxHideAndErrorMessageBox(FancyBaseDialog *a1, HWND hWnd, LPCSTR a3, ...)
{
  CHAR Text[2048]; // [esp+0h] [ebp-800h] BYREF
  va_list arglist; // [esp+810h] [ebp+10h] BYREF

  va_start(arglist, a3);
  wvsprintfA(Text, a3, arglist);
  FancyBoxHideWindow(a1);
  return MessageBoxA(hWnd, Text, "FancyBox Err", 0x10u);
}

//----- (00402090) --------------------------------------------------------
char *__thiscall sub_402090(FancyBox *this, unsigned int a2)
{
  char *buffer; // ecx
  FancyStr v5; // [esp+8h] [ebp-24h] BYREF
  FancyStr v6; // [esp+14h] [ebp-18h] BYREF
  int v7; // [esp+28h] [ebp-4h]

  if ( a2 > 2 )
    return 0;
  if ( this->field_CAC[a2] >= 1 )
  {
    strcpy(byte_417178, (const char *)&this->field_A8 + 512 * a2 + 32 * (rand() % this->field_CAC[a2]) + 1);
    return byte_417178;
  }
  if ( a2 )
    return 0;
  FancyStrCtor(&v6);
  v7 = 0;
  FancyStrCtor(&v5);
  LOBYTE(v7) = 1;
  FancyStrSet(&v6, (const char **)&this->strCommandSystem.buffer);
  FancyStrRemove(&v6, 0, 7);
  FancyStrSubstring(&v6, &v5, '/', 0, 0);
  if ( v5.len < 1 || (buffer = v5.buffer) == 0 )
    buffer = emptyString;
  strcpy(byte_417178, buffer);
  LOBYTE(v7) = 0;
  FancyStrDtor(&v5);
  v7 = -1;
  FancyStrDtor(&v6);
  return byte_417178;
}

//----- (004021D0) --------------------------------------------------------
char *__thiscall sub_4021D0(FancyBox *this, unsigned int a2)
{
  if ( a2 > 2 || this->field_CB8[a2] < 1 )
    return 0;
  strcpy(byte_417198, (const char *)&this->field_6A8 + 512 * a2 + 32 * (rand() % this->field_CB8[a2]) + 1);
  return byte_417198;
}

//----- (00402230) --------------------------------------------------------
void __cdecl UpdateProgress(int a1, unsigned int a2)
{
  unsigned int v2; // esi

  if ( fancyBox.field_CE0 )
  {
    if ( fancyBox.updateDialog )
    {
      v2 = (unsigned int)(100 * (a1 + fancyBox.field_CD8)) / fancyBox.field_CD4;
      FancyUpdateDialogSetDownloadPercentage(fancyBox.updateDialog, 100 * a1 / a2);
      FancyUpdateDialogSetUpdatePercentage(fancyBox.updateDialog, (int)(90 * v2) / 100 + 5);
    }
  }
}

//----- (004022A0) --------------------------------------------------------
CacheStore *__thiscall CacheStoreInitialize(CacheStore *this)
{
  FancyStrCtor(this);
  FancyStrCtor(&this->strBufferUnused.buffer);
  FancyStrCtor(&this->strDrive.buffer);
  FancyStrCtor(&this->strFullPath.buffer);
  FancyStrCtor(&this->strSystem.buffer);
  FancyStrFromCStr(&this->strPath, "Program Files\\FancyBoxII Games\\");
  FancyStrFromCStr(&this->strBufferUnused, "fcbox2");
  return this;
}

//----- (00402330) --------------------------------------------------------
void __stdcall EnsureDirectory(LPCSTR lpString2)
{
  signed int v1; // eax
  int v2; // edi
  signed int i; // ecx
  char v4; // cl
  char *v5; // eax
  void (__stdcall *fSetCurrentDirectoryA)(LPCSTR); // ebp
  FancyStr *v7; // esi
  FancyStr *v8; // esi
  int v9; // edi
  char *v10; // eax
  char *v11; // eax
  FancyStr lpPathName; // [esp+0h] [ebp-484h] BYREF
  struct _SECURITY_ATTRIBUTES SecurityAttributes; // [esp+Ch] [ebp-478h] BYREF
  char String1[260]; // [esp+18h] [ebp-46Ch] BYREF
  CHAR Buffer[260]; // [esp+11Ch] [ebp-368h] BYREF
  const char *v16[3]; // [esp+220h] [ebp-264h] BYREF
  char v17; // [esp+22Ch] [ebp-258h] BYREF
  int v18; // [esp+480h] [ebp-4h]

  lstrcpyA(String1, lpString2);
  v1 = strlen(String1) - 1;
  v2 = 0;
  for ( i = 0; i < v1; ++i )
  {
    if ( String1[i] == '/' )
      String1[i] = '\\';
  }
  for ( ; v1 > 2; --v1 )
  {
    if ( String1[v1] == '\\' )
      break;
  }
  v4 = String1[v1];
  v5 = &String1[v1];
  if ( v4 == '\\' )
  {
    *v5 = 0;
    GetCurrentDirectoryA(0x104u, Buffer);
    fSetCurrentDirectoryA = (void (__stdcall *)(LPCSTR))SetCurrentDirectoryA;
    if ( SetCurrentDirectoryA(String1) )
    {
      SetCurrentDirectoryA(Buffer);
    }
    else
    {
      FancyStrCtor(&lpPathName);
      v18 = 0;
      vector_constructor(
        (char *)v16,
        0xCu,
        50,
        (void (__thiscall *)(void *))FancyStrCtor,
        (void (__thiscall *)(void *))FancyStrDtor);
      LOBYTE(v18) = 1;
      FancyStrFromCStr(&lpPathName, String1);
      if ( lpPathName.len )
      {
        v7 = (FancyStr *)v16;
        do
        {
          FancyStrSubstring(&lpPathName, v7, '\\', 0, 0);
          ++v2;
          ++v7;
        }
        while ( lpPathName.len );
      }
      FancyStrSet(&lpPathName, v16);
      if ( v2 > 1 )
      {
        v8 = (FancyStr *)&v17;
        v9 = v2 - 1;
        do
        {
          FancyStrAppendCStr(&lpPathName, "\\");
          FancyStrAppend(&lpPathName, v8);
          if ( lpPathName.len < 1 || (v10 = lpPathName.buffer) == 0 )
            v10 = emptyString;
          if ( !SetCurrentDirectoryA(v10) )
          {
            SecurityAttributes.nLength = 12;
            SecurityAttributes.lpSecurityDescriptor = 0;
            SecurityAttributes.bInheritHandle = 0;
            if ( lpPathName.len < 1 || (v11 = lpPathName.buffer) == 0 )
              v11 = emptyString;
            CreateDirectoryA(v11, &SecurityAttributes);
          }
          ++v8;
          --v9;
        }
        while ( v9 );
        fSetCurrentDirectoryA = (void (__stdcall *)(LPCSTR))SetCurrentDirectoryA;
      }
      fSetCurrentDirectoryA(Buffer);
      LOBYTE(v18) = 0;
      vector_destructor(v16, 0xCu, 50, (void (__thiscall *)(void *))FancyStrDtor);
      v18 = -1;
      FancyStrDtor(&lpPathName);
    }
  }
}
// 402330: using guessed type CHAR String1[260];

//----- (00402550) --------------------------------------------------------
void __stdcall RemoveEmptyDirectoryRecursively(LPCSTR lpString2)
{
  signed int v1; // esi
  signed int i; // eax
  char String1[260]; // [esp+0h] [ebp-104h] BYREF

  lstrcpyA(String1, lpString2);
  v1 = strlen(String1) - 1;
  for ( i = 0; i < v1; ++i )
  {
    if ( String1[i] == '/' )
      String1[i] = '\\';
  }
  if ( v1 <= 2 )
  {
LABEL_8:
    if ( String1[v1] != '\\' )
      return;
  }
  else
  {
    while ( String1[v1] != '\\' )
    {
      if ( --v1 <= 2 )
        goto LABEL_8;
    }
  }
  for ( String1[v1] = 0; v1 > 2; String1[v1] = 0 )
  {
    if ( !RemoveDirectoryA(String1) )
      break;
    while ( String1[v1] != '\\' )
    {
      if ( --v1 <= 2 )
      {
        if ( String1[v1] != '\\' )
          return;
        break;
      }
    }
  }
}
// 4025D1: conditional instruction was optimized away because esi.4>=3
// 402550: using guessed type CHAR String1[260];

//----- (00402600) --------------------------------------------------------
BOOL __stdcall TestWriteToPath(char *a2)
{
  char *buffer; // eax
  HANDLE FirstFileA; // eax
  char *v3; // eax
  FILE *v4; // esi
  char *v5; // eax
  HANDLE v6; // eax
  char *v8; // eax
  char *v9; // eax
  char *v10; // esi
  FancyStr lpFileName; // [esp+10h] [ebp-160h] BYREF
  char v12[8]; // [esp+1Ch] [ebp-154h] BYREF
  struct _WIN32_FIND_DATAA FindFileData; // [esp+24h] [ebp-14Ch] BYREF
  int v14; // [esp+16Ch] [ebp-4h]

  FancyStrCtorFromCStr(&lpFileName, a2);
  v14 = 0;
  FancyStrAppendCStr(&lpFileName, "fcbox2.ini");
  if ( lpFileName.len < 1 || (buffer = lpFileName.buffer) == 0 )
    buffer = emptyString;
  FirstFileA = FindFirstFileA(buffer, &FindFileData);
  if ( FirstFileA == (HANDLE)-1 )
  {
    if ( lpFileName.len < 1 || (v3 = lpFileName.buffer) == 0 )
      v3 = emptyString;
    v4 = fopen(v3, "wb");
    if ( !v4 )
      goto LABEL_15;
    strcpy(v12, "ISBCC");
    fwrite(v12, 1u, 6u, v4);
    fclose(v4);
  }
  else
  {
    FindClose(FirstFileA);
  }
  if ( lpFileName.len < 1 || (v5 = lpFileName.buffer) == 0 )
    v5 = emptyString;
  v6 = FindFirstFileA(v5, &FindFileData);
  if ( v6 == (HANDLE)-1 )
  {
LABEL_15:
    v14 = -1;
    FancyStrDtor(&lpFileName);
    return 0;
  }
  FindClose(v6);
  if ( lpFileName.len < 1 || (v8 = lpFileName.buffer) == 0 )
    v8 = emptyString;
  DeleteFileA(v8);
  if ( lpFileName.len < 1 || (v9 = lpFileName.buffer) == 0 )
    v9 = emptyString;
  v10 = (char *)FindFirstFileA(v9, &FindFileData);
  FindClose(v10);
  v14 = -1;
  FancyStrDtor(&lpFileName);
  return v10 + 1 == 0;
}

//----- (00402790) --------------------------------------------------------
void __thiscall FancyBoxCtor(FancyBox *this)
{
  FancyStr *p_strCommandDll; // ebp
  char *String; // eax

  p_strCommandDll = &this->strCommandDll;
  FancyStrCtor(&this->strCommandDll);
  FancyStrCtor(&this->strCommandRaw);
  FancyStrCtor(&this->field_2C);
  FancyStrCtor(&this->field_38);
  FancyStrCtor(&this->objsysDllPath);
  FancyStrCtor(&this->field_50);
  FancyStrCtor(&this->strCommandSystem);
  FancyStrCtor(&this->cmdLine);
  FancyStrCtor(&this->strCommandSV);
  FancyStrCtor(&this->strCommandC);
  FancyStrCtor(&this->strCommandI);
  FancyStrCtor(&this->updateMessage);
  this->hObjsys = 0;
  this->fStdInitFancyBox = 0;
  this->fStdCmdFancyBox = 0;
  this->hWnd = 0;
  this->objsysReady = 0;
  InitialzeHexMap();
  FancyStrFromCStr(p_strCommandDll, aObjsysDll);
  String = (char *)FancyRegReadString("fcbox2", "syshomeadd", (BYTE *)"http://fcbox/download/system");
  FancyStrFromCStr(&this->strCommandSystem, String);
  FancyStrTrimTailChar(&this->strCommandSystem, '/');
  FancyStrAppendCStr(&this->strCommandSystem, "/");
  this->field_74 = 0;
  this->field_A8 = 0;
  this->field_68 = 0;
  this->field_70 = 5;
  this->field_CAC[0] = 0;
  this->field_CAC[1] = 0;
  this->field_CAC[2] = 0;
  this->field_CB8[0] = 0;
  this->field_CB8[1] = 0;
  this->field_CB8[2] = 0;
  this->field_CD0 = 0;
}

//----- (00402900) --------------------------------------------------------
void __thiscall sub_402900(FancyBox *this, FancyStr *a2)
{
  signed int v3; // edi
  FancyStr *v4; // eax
  BOOL v5; // esi
  FancyStr *v6; // ebp
  char *v7; // esi
  FancyDownloader *v8; // eax
  FancyDownloader *v9; // esi
  int v10; // eax
  int v11; // ebp
  int v12; // ecx
  FancyDownloader *v13; // eax
  int v14; // ebx
  int i; // esi
  FancyDownloader *v16; // edi
  char *buffer; // eax
  char *v18; // eax
  char v19; // [esp+Fh] [ebp-81h]
  int v20; // [esp+10h] [ebp-80h]
  FancyStr v21; // [esp+18h] [ebp-78h] BYREF
  FancyStr v22; // [esp+24h] [ebp-6Ch] BYREF
  FancyStr v23; // [esp+30h] [ebp-60h] BYREF
  FancyDownloader *v24[3]; // [esp+3Ch] [ebp-54h] BYREF
  FancyStr lpFileName; // [esp+48h] [ebp-48h] BYREF
  FancyStr v26; // [esp+54h] [ebp-3Ch] BYREF
  FancyStr v27[3]; // [esp+60h] [ebp-30h] BYREF
  int v28; // [esp+8Ch] [ebp-4h]

  FancyStrCtor(&v23);
  v3 = 0;
  v28 = 0;
  FancyStrSetStr(&v22, (const char **)&a2->buffer);
  LOBYTE(v28) = 1;
  FancyStrToLower(&v22);
  v4 = FancyStrSubString(&v22, &v26, 0, 7);
  LOBYTE(v28) = 2;
  v5 = FancyStrNotEqual(v4, "http://");
  LOBYTE(v28) = 1;
  FancyStrDtor(&v26);
  if ( v5 )
  {
    LOBYTE(v28) = 0;
    FancyStrDtor(&v22);
    v28 = -1;
    FancyStrDtor(&v23);
  }
  else
  {
    FancyStrSubstring(&v22, &v23, ' ', 0, 0);
    FancyStrSet(&v22, (const char **)&v23.buffer);
    FancyStrSubstring(&v22, &v23, ',', 0, 0);
    FancyStrSet(&v22, (const char **)&v23.buffer);
    FancyStrSubstring(&v22, &v23, '+', 0, 0);
    FancyStrSet(&v22, (const char **)&v23.buffer);
    FancyStrSubstring(&v22, &v23, '?', 0, 0);
    FancyStrSet(&v22, (const char **)&v23.buffer);
    v19 = 0;
    FancyStrCtor(&lpFileName);
    LOBYTE(v28) = 3;
    FancyStrCtor(&v21);
    LOBYTE(v28) = 4;
    FancyStrCtor(&v26);
    LOBYTE(v28) = 5;
    vector_constructor((char *)v27, 0xCu, 3, (void (__thiscall *)(void *))FancyStrCtor, FancyStrDtor);
    memset(v24, 0, sizeof(v24));
    LOBYTE(v28) = 6;
    v20 = -1;
    FancyStrSet(&lpFileName, (const char **)&this->field_2C.buffer);
    FancyStrAppendCStr(&lpFileName, "checkfile.dat");
    v6 = v27;
    do
    {
      v7 = sub_4021D0(this, v3);
      if ( v7 )
      {
        FancyStrSet(&v21, (const char **)&v22.buffer);
        FancyStrRemove(&v21, 0, 7);
        FancyStrSubstring(&v21, &v26, '/', 0, 0);
        FancyStrInsert(&v21, 0, '/');
        FancyStrInsertCStrAt(&v21, 0, v7);
        FancyStrInsertCStrAt(&v21, 0, "http://");
        FancyStrFromCStr(v6, v7);
        v8 = (FancyDownloader *)operator new(0x60u);
        LOBYTE(v28) = 7;
        if ( v8 )
          v9 = FancyDownloaderCtor(v8);
        else
          v9 = 0;
        LOBYTE(v28) = 6;
        v24[v3] = v9;
        FancyStrSet(&v9->netPath, (const char **)&v21.buffer);
        FancyStrSet(&v9->localPath, (const char **)&lpFileName.buffer);
        v9->field_48 = 0;
        FancyDownloaderOpen(v9);
      }
      ++v3;
      ++v6;
    }
    while ( v3 < 3 );
    v10 = 0;
    while ( !v24[v10] )
    {
      if ( ++v10 >= 3 )
        goto LABEL_38;
    }
    if ( v10 != -1 )
    {
      v11 = 1;
      while ( 1 )
      {
        v12 = 0;
        while ( 1 )
        {
          v13 = v24[v12];
          if ( v13 )
          {
            if ( v13->stage == 2 || v13->stage == 4 )
              break;
          }
          if ( ++v12 >= 3 )
          {
            v14 = v20;
            goto LABEL_26;
          }
        }
        v14 = v12;
        v20 = v12;
        v19 = 1;
        for ( i = 0; i < 3; ++i )
        {
          v16 = v24[i];
          if ( v16 )
          {
            FancyDownloaderDtor(v24[i]);
            j__free(v16);
          }
          v24[i] = 0;
        }
LABEL_26:
        if ( !processWindowsMessages() || v11 > 100 )
          break;
        Sleep(6u);
        ++v11;
        if ( v14 != -1 )
        {
          v14 = v20;
          break;
        }
      }
      if ( v19 )
      {
        FancyStrSet(&v21, (const char **)&a2->buffer);
        FancyStrRemove(&v21, 0, 7);
        FancyStrSubstring(&v21, &v26, 47, 0, 0);
        FancyStrInsert(&v21, 0, 47);
        if ( v27[v14].len < 1 || (buffer = v27[v14].buffer) == 0 )
          buffer = emptyString;
        FancyStrInsertCStrAt(&v21, 0, buffer);
        FancyStrInsertCStrAt(&v21, 0, "http://");
        FancyStrSet(a2, (const char **)&v21.buffer);
        if ( lpFileName.len < 1 || (v18 = lpFileName.buffer) == 0 )
          v18 = emptyString;
        DeleteFileA(v18);
      }
    }
LABEL_38:
    LOBYTE(v28) = 5;
    vector_destructor(v27, 0xCu, 3, FancyStrDtor);
    LOBYTE(v28) = 4;
    FancyStrDtor(&v26);
    LOBYTE(v28) = 3;
    FancyStrDtor(&v21);
    LOBYTE(v28) = 1;
    FancyStrDtor(&lpFileName);
    LOBYTE(v28) = 0;
    FancyStrDtor(&v22);
    v28 = -1;
    FancyStrDtor(&v23);
  }
}

//----- (00402D70) --------------------------------------------------------
int __thiscall FancyBoxUpdateSystem(FancyBox *this, HWND hWnd)
{
  char *buffer; // eax
  FancyStr *p_strCommandSystem; // ebx
  FancyStr *p_updateMessage; // esi
  char *v7; // esi
  char *v8; // eax
  signed int v9; // edi
  FancyStr *v10; // ebp
  char *v11; // esi
  FancyDownloader *v12; // eax
  FancyDownloader *v13; // esi
  int v14; // ecx
  FancyDownloader *v15; // eax
  int i; // edi
  FancyDownloader *v17; // esi
  FancyDownloader *v18; // eax
  int j; // edi
  void *v20; // esi
  char *v21; // eax
  char *v22; // eax
  int v23; // esi
  int v24; // edi
  int v25; // eax
  char *Line; // eax
  unsigned int v28; // eax
  char *v29; // ecx
  int v30; // esi
  char *v31; // eax
  unsigned int v32; // eax
  char *v33; // ecx
  int Integer; // edi
  int v35; // ebp
  char *v36; // eax
  char *v37; // eax
  char *v38; // esi
  char *v39; // ecx
  char *v40; // eax
  int v41; // ebx
  int v42; // ebp
  char *v43; // eax
  char *v44; // eax
  FancyStr *v45; // esi
  char *v46; // esi
  char *v47; // edi
  char *v48; // eax
  char *v49; // eax
  char *v50; // eax
  int v51; // eax
  WPARAM v52; // edi
  char *v53; // esi
  FancyStr *p_strCommandRaw; // esi
  int v55; // ebx
  char *v56; // eax
  char *v57; // eax
  char *v58; // eax
  char *v59; // eax
  char *v60; // esi
  char *v61; // ecx
  time_t v62; // eax
  char *v63; // eax
  FancyStr *v64; // esi
  char *v65; // eax
  char v66; // [esp+Fh] [ebp-105h]
  FancyStr lpFileName; // [esp+10h] [ebp-104h] BYREF
  int v68; // [esp+1Ch] [ebp-F8h]
  FancyBox *v69; // [esp+20h] [ebp-F4h] MAPDST
  FancyStr v70; // [esp+24h] [ebp-F0h] BYREF
  FancyStr v71; // [esp+30h] [ebp-E4h] BYREF
  FancyStr v72; // [esp+3Ch] [ebp-D8h] BYREF
  FancyStr arglist; // [esp+48h] [ebp-CCh] BYREF
  FancyDownloader *v74[3]; // [esp+54h] [ebp-C0h] BYREF
  FancyStr v75; // [esp+54h] [ebp-C0h] FORCED BYREF
  FancyStr v76; // [esp+60h] [ebp-B4h] BYREF
  FancyStr v77; // [esp+6Ch] [ebp-A8h] BYREF
  FancyDownloader *v78; // [esp+78h] [ebp-9Ch]
  int v79; // [esp+78h] [ebp-9Ch] FORCED
  FancyLinedText v80; // [esp+7Ch] [ebp-98h] BYREF
  FancyStr v81; // [esp+8Ch] [ebp-88h] BYREF
  FancyStr v82; // [esp+98h] [ebp-7Ch] BYREF
  FancyUpdateDialog v83; // [esp+A4h] [ebp-70h] BYREF
  FancyStr v84; // [esp+D8h] [ebp-3Ch] BYREF
  FancyStr v85[3]; // [esp+E4h] [ebp-30h] BYREF
  int v86; // [esp+110h] [ebp-4h]

  v69 = this;
  FancyStrCtor(&v76);
  v86 = 0;
  FancyStrCtor(&lpFileName);
  LOBYTE(v86) = 1;
  FancyStrCtor(&arglist);
  LOBYTE(v86) = 2;
  FancyUpdateDialogCtor(&v83);
  LOBYTE(v86) = 3;
  fancyBox.updateDialog = &v83;
  fancyBox.field_CE0 = 1;
  fancyBox.field_CD8 = 0;
  FancyStrSet(&v76, (const char **)&this->field_2C.buffer);
  FancyStrSet(&lpFileName, (const char **)&v76.buffer);
  FancyStrAppendCStr(&lpFileName, aFc2infoDat);
  if ( lpFileName.len < 1 || (buffer = lpFileName.buffer) == 0 )
    buffer = emptyString;
  if ( CompareTime(buffer, this->field_70, 0, 0) )
  {
    LOBYTE(v86) = 2;
    FancyUpdateDialogRelease(&v83);
    LOBYTE(v86) = 1;
    FancyStrDtor(&arglist);
    LOBYTE(v86) = 0;
    FancyStrDtor(&lpFileName);
    v86 = -1;
    FancyStrDtor(&v76);
    return 1;
  }
  p_strCommandSystem = &this->strCommandSystem;
  FancyStrSet(&arglist, (const char **)&this->strCommandSystem.buffer);
  FancyStrAppendCStr(&arglist, aFc2infoDat);
  FancyUpdateDialogCreate(&v83, this->hInstance, 0, this->field_CD0);
  p_updateMessage = &this->updateMessage;
  FancyStrFromCStr(p_updateMessage, "Check system info\r\nWaiting...");
  if ( p_updateMessage->len < 1 || (v7 = p_updateMessage->buffer) == 0 )
    v7 = emptyString;
  FancyUpdateDialogSetDownloadingText(fancyBox.updateDialog, v7, 1);
  FancyUpdateDialogSetUpdatePercentage(fancyBox.updateDialog, 0);
  if ( lpFileName.len < 1 || (v8 = lpFileName.buffer) == 0 )
    v8 = emptyString;
  FancyBoxChangeAndCreateDirectory(v8);
  v66 = 0;
  FancyStrCtor(&v82);
  LOBYTE(v86) = 4;
  FancyStrCtor(&v84);
  LOBYTE(v86) = 5;
  vector_constructor((char *)v85, 0xCu, 3, (void (__thiscall *)(void *))FancyStrCtor, FancyStrDtor);
  memset(v74, 0, sizeof(v74));
  LOBYTE(v86) = 6;
  v68 = -1;
  v9 = 0;
  v10 = v85;
  do
  {
    v11 = sub_402090(v69, v9);
    if ( v11 )
    {
      FancyStrSet(&v82, (const char **)&p_strCommandSystem->buffer);
      FancyStrRemove(&v82, 0, 7);
      FancyStrSubstring(&v82, &v84, 47, 0, 0);
      FancyStrInsert(&v82, 0, 47);
      FancyStrInsertCStrAt(&v82, 0, v11);
      FancyStrInsertCStrAt(&v82, 0, "http://");
      FancyStrSet(v10, (const char **)&v82.buffer);
      v12 = (FancyDownloader *)operator new(0x60u);
      v78 = v12;
      LOBYTE(v86) = 7;
      if ( v12 )
        v13 = FancyDownloaderCtor(v12);
      else
        v13 = 0;
      LOBYTE(v86) = 6;
      v74[v9] = v13;
      FancyStrAppendCStr(&v82, aFc2infoDat);
      FancyStrSet(&v13->netPath, (const char **)&v82.buffer);
      FancyStrSet(&v13->localPath, (const char **)&lpFileName.buffer);
      v13->field_48 = 0;
      FancyDownloaderOpen(v13);
    }
    ++v9;
    ++v10;
  }
  while ( v9 < 3 );
  while ( 1 )
  {
    v14 = 0;
    while ( 1 )
    {
      v15 = v74[v14];
      if ( v15 )
      {
        if ( v15->stage == 2 || v15->stage == 4 )
          break;
      }
      if ( ++v14 >= 3 )
        goto LABEL_35;
    }
    v68 = v14;
    for ( i = 0; i < 3; ++i )
    {
      v17 = v74[i];
      if ( v17 && v68 != i )
      {
        FancyDownloaderDtor(v74[i]);
        j__free(v17);
        v74[i] = 0;
      }
    }
LABEL_35:
    if ( v83.field_24 || !processWindowsMessages() )
      break;
    Sleep(6u);
    while ( v68 != -1 )
    {
      v18 = v74[v68];
      if ( v18->stage != 2 )
      {
        if ( v18->stage != 4 )
          goto LABEL_35;
        v66 = 1;
        for ( j = 0; j < 3; ++j )
        {
          v20 = (void *)*((_DWORD *)&v75.buffer + j);
          if ( v20 )
          {
            FancyDownloaderDtor(v74[j]);
            j__free(v20);
            *((_DWORD *)&v75.buffer + j) = 0;
          }
        }
        FancyStrSet(&v69->strCommandSystem, (const char **)&v85[v68].buffer);
        goto LABEL_43;
      }
    }
  }
LABEL_43:
  LOBYTE(v86) = 5;
  vector_destructor(v85, 0xCu, 3, FancyStrDtor);
  LOBYTE(v86) = 4;
  FancyStrDtor(&v84);
  LOBYTE(v86) = 3;
  FancyStrDtor(&v82);
  if ( !v66 )
  {
    if ( !v83.field_24 )
    {
      if ( arglist.len < 1 || (v21 = arglist.buffer) == 0 )
        v21 = emptyString;
      FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Download system info failed\r\n%s", v21);
    }
    goto LABEL_49;
  }
  FancyLinedTextCtor(&v80);
  LOBYTE(v86) = 8;
  if ( lpFileName.len < 1 || (v22 = lpFileName.buffer) == 0 )
    v22 = emptyString;
  if ( !FancyLinedTextFillFromPath(&v80, v22) )
  {
    FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Can't read system info!");
    LOBYTE(v86) = 3;
    FancyLinedTextDtor(&v80);
    goto LABEL_49;
  }
  v23 = 0;
  FancyStrCtor(&v70);
  LOBYTE(v86) = 9;
  FancyStrCtor(&v72);
  LOBYTE(v86) = 10;
  FancyStrCtor(&v71);
  LOBYTE(v86) = 11;
  FancyStrCtor(&v81);
  LOBYTE(v86) = 12;
  FancyStrCtor(&v77);
  LOBYTE(v86) = 13;
  v24 = 0;
  v25 = FancyLinedTextSize(&v80);
  if ( v25 > 0 )
  {
    do
    {
      if ( v83.field_24 )
        goto LABEL_159;
      Line = FancyLinedTextGetLine(&v80, v24);
      FancyStrFromCStr(&v70, Line);
      if ( v70.len >= 3 )
      {
        FancyStrSubstring(&v70, &v72, 44, 0, 0);
        if ( !v69->field_A8 )
          goto LABEL_63;
        v28 = strlen(aFcrunerExe);
        if ( v72.len < 1 || (v29 = v72.buffer) == 0 )
          v29 = emptyString;
        if ( _strnicmp(v29, aFcrunerExe, v28 - 3) )
        {
LABEL_63:
          v23 += FancyStrGetInteger(&v70, 0, ',');
          FancyStrGetInteger(&v70, 0, ';');
        }
      }
      ++v24;
    }
    while ( v24 < FancyLinedTextSize(&v80) );
  }
  fancyBox.field_CD4 = v23;
  FancyUpdateDialogSetUpdatePercentage(fancyBox.updateDialog, 5u);
  v30 = 0;
  v68 = 0;
  v79 = 0;
  if ( FancyLinedTextSize(&v80) <= 0 )
  {
LABEL_118:
    fancyBox.field_CE0 = 0;
    v52 = 95;
    FancyUpdateDialogSetDownloadPercentage(fancyBox.updateDialog, 100u);
    FancyUpdateDialogSetUpdatePercentage(fancyBox.updateDialog, 95u);
    if ( v68 > 0 )
      Sleep(0x1Eu);
    if ( v69->strCommandRaw.len )
    {
      FancyStrFromCStr(&v69->updateMessage, "Check script file...");
      if ( v69->updateMessage.len < 1 || (v53 = v69->updateMessage.buffer) == 0 )
        v53 = emptyString;
      FancyUpdateDialogSetDownloadingText(&v83, v53, 0);
      FancyStrFromCStr(&v77, emptyString0);
      if ( v69->strCommandRaw.len )
      {
        p_strCommandRaw = &v69->strCommandRaw;
        do
        {
          v55 = FancyStrFind(p_strCommandRaw, "?", 0);
          if ( FancyStrFind(p_strCommandRaw, ",", 0) <= v55 )
          {
            FancyStrSubstring(p_strCommandRaw, &v70, 44, 0, 0);
          }
          else
          {
            FancyStrSet(&v70, (const char **)&p_strCommandRaw->buffer);
            if ( p_strCommandRaw->buffer )
              j__free(p_strCommandRaw->buffer);
            p_strCommandRaw->buffer = 0;
            p_strCommandRaw->len = 0;
            p_strCommandRaw->capacity = 0;
          }
          sub_402900(v69, &v70);
          FancyStrAppend(&v77, &v70);
          FancyStrAppendCStr(&v77, ",");
          v52 += 2;
          FancyUpdateDialogSetUpdatePercentage(fancyBox.updateDialog, v52);
        }
        while ( v69->strCommandRaw.len );
      }
      FancyStrTrimTailChar(&v77, 44);
      FancyStrSet(&v69->strCommandRaw, (const char **)&v77.buffer);
    }
    Sleep(0x1Eu);
    FancyUpdateDialogSetUpdatePercentage(fancyBox.updateDialog, 100u);
    v64 = &v69->updateMessage;
    FancyStrFromCStr(&v69->updateMessage, "Update ok!");
    if ( v69->updateMessage.len < 1 || (v65 = v64->buffer) == 0 )
      v65 = emptyString;
    FancyUpdateDialogSetDownloadingText(&v83, v65, 0);
    Sleep(0x1Eu);
    LOBYTE(v86) = 12;
    FancyStrDtor(&v77);
    LOBYTE(v86) = 11;
    FancyStrDtor(&v81);
    LOBYTE(v86) = 10;
    FancyStrDtor(&v71);
    LOBYTE(v86) = 9;
    FancyStrDtor(&v72);
    LOBYTE(v86) = 8;
    FancyStrDtor(&v70);
    LOBYTE(v86) = 3;
    FancyLinedTextDtor(&v80);
    LOBYTE(v86) = 2;
    FancyUpdateDialogRelease(&v83);
    LOBYTE(v86) = 1;
    FancyStrDtor(&arglist);
    LOBYTE(v86) = 0;
    FancyStrDtor(&lpFileName);
    v86 = -1;
    FancyStrDtor(&v76);
    return 1;
  }
  while ( 1 )
  {
    if ( v83.field_24 )
      goto LABEL_159;
    v31 = FancyLinedTextGetLine(&v80, v30);
    FancyStrFromCStr(&v70, v31);
    if ( v70.len < 3 )
      goto LABEL_117;
    FancyStrSet(&v77, (const char **)&v70.buffer);
    FancyStrSubstring(&v70, &v72, 44, 0, 0);
    if ( v69->field_A8 )
    {
      v32 = strlen(aFcrunerExe);
      if ( v72.len < 1 || (v33 = v72.buffer) == 0 )
        v33 = emptyString;
      if ( !_strnicmp(v33, aFcrunerExe, v32 - 3) )
        goto LABEL_117;
    }
    Integer = FancyStrGetInteger(&v70, 0, ',');
    v35 = FancyStrGetInteger(&v70, 0, ';');
    FancyStrSet(&lpFileName, (const char **)&v76.buffer);
    FancyStrAppend(&lpFileName, &v72);
    FancyStrSet(&v81, (const char **)&lpFileName.buffer);
    if ( lpFileName.len < 1 || (v36 = lpFileName.buffer) == 0 )
      v36 = emptyString;
    if ( !VerifyFileSizeAndTime(v36, v35, Integer) )
      break;
LABEL_91:
    fancyBox.field_CD8 += Integer;
    FancyStrSubstring(&v70, &v71, ',', 0, 0);
    v41 = FancyStrGetInteger(&v70, 0, ',');
    v42 = FancyStrGetInteger(&v70, 0, ',');
    FancyStrSet(&lpFileName, (const char **)&v76.buffer);
    FancyStrAppend(&lpFileName, &v71);
    if ( lpFileName.len < 1 || (v43 = lpFileName.buffer) == 0 )
      v43 = emptyString;
    if ( VerifyFileSizeAndTime(v43, v42, v41) )
      goto LABEL_117;
    FancyStrCtor(&v75);
    LOBYTE(v86) = 14;
    if ( v71.len < 1 || (v44 = v71.buffer) == 0 )
      v44 = emptyString;
    v45 = &v69->updateMessage;
    FancyStrSetVAStr(&v69->updateMessage, "Uncab file %s...", v44);
    if ( v45->len < 1 || (v46 = v45->buffer) == 0 )
      v46 = emptyString;
    FancyUpdateDialogSetDownloadingText(&v83, v46, 1);
    if ( lpFileName.len < 1 || (v47 = lpFileName.buffer) == 0 )
      v47 = emptyString;
    if ( v81.len < 1 || (v48 = v81.buffer) == 0 )
      v48 = emptyString;
    if ( !sub_401D30(v47, &v75, v48) )
    {
      if ( v71.len < 1 || (v57 = v71.buffer) == 0 )
        v57 = emptyString;
      FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Uncab %s failed!", v57);
      goto LABEL_158;
    }
    if ( lpFileName.len < 1 || (v49 = lpFileName.buffer) == 0 )
      v49 = emptyString;
    if ( !FancySetFileTime(v49, v42) )
    {
      if ( v71.len < 1 || (v58 = v71.buffer) == 0 )
        v58 = emptyString;
      FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Can't set %s date", v58);
      goto LABEL_158;
    }
    if ( lpFileName.len < 1 || (v50 = lpFileName.buffer) == 0 )
      v50 = emptyString;
    if ( !VerifyFileSizeAndTime(v50, v42, v41) )
    {
      if ( lpFileName.len < 1 || (v59 = lpFileName.buffer) == 0 )
        v59 = emptyString;
      if ( VerifyFileSizeAndTime(v59, v42, 0) )
      {
        if ( v71.len < 1 || (v63 = v71.buffer) == 0 )
          v63 = emptyString;
        FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Check uncab %s length err", v63);
      }
      else
      {
        v60 = emptyString;
        if ( lpFileName.len < 1 || (v61 = lpFileName.buffer) == 0 )
          v61 = emptyString;
        if ( v71.len >= 1 && v71.buffer )
          v60 = v71.buffer;
        v62 = GetLastWriteTime(v61);
        FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Check uncab %s date err,%X must be %X", v60, v62, v42);
      }
LABEL_158:
      LOBYTE(v86) = 13;
      FancyStrDtor(&v75);
      goto LABEL_159;
    }
    ++v68;
    LOBYTE(v86) = 13;
    FancyStrDtor(&v75);
LABEL_117:
    v30 = ++v79;
    v51 = FancyLinedTextSize(&v80);
    if ( v30 >= v51 )
      goto LABEL_118;
  }
  if ( v72.len < 1 || (v37 = v72.buffer) == 0 )
    v37 = emptyString;
  FancyStrSetVAStr(&v69->updateMessage, "Downloading %s...", v37);
  if ( v69->updateMessage.len < 1 || (v38 = v69->updateMessage.buffer) == 0 )
    v38 = emptyString;
  FancyUpdateDialogSetDownloadingText(&v83, v38, 1);
  FancyBoxHideOrDeactiveWindow(&v83, 1);
  FancyStrSet(&arglist, (const char **)&v69->strCommandSystem.buffer);
  FancyStrAppend(&arglist, &v72);
  if ( lpFileName.len < 1 || (v39 = lpFileName.buffer) == 0 )
    v39 = emptyString;
  if ( arglist.len < 1 || (v40 = arglist.buffer) == 0 )
    v40 = emptyString;
  if ( sub_405230(v40, v39, v35, Integer, UpdateProgress) )
  {
    ++v68;
    goto LABEL_91;
  }
  if ( !v83.field_24 )
  {
    if ( v72.len < 1 || (v56 = v72.buffer) == 0 )
      v56 = emptyString;
    FancyBoxHideAndErrorMessageBox(&v83, hWnd, "Can't download %", v56);
  }
LABEL_159:
  LOBYTE(v86) = 12;
  FancyStrDtor(&v77);
  LOBYTE(v86) = 11;
  FancyStrDtor(&v81);
  LOBYTE(v86) = 10;
  FancyStrDtor(&v71);
  LOBYTE(v86) = 9;
  FancyStrDtor(&v72);
  LOBYTE(v86) = 8;
  FancyStrDtor(&v70);
  LOBYTE(v86) = 3;
  FancyLinedTextDtor(&v80);
LABEL_49:
  LOBYTE(v86) = 2;
  FancyUpdateDialogRelease(&v83);
  LOBYTE(v86) = 1;
  FancyStrDtor(&arglist);
  LOBYTE(v86) = 0;
  FancyStrDtor(&lpFileName);
  v86 = -1;
  FancyStrDtor(&v76);
  return 0;
}
// 40316A: conditional instruction was optimized away because %var_105.1==0

//----- (00403C00) --------------------------------------------------------
void __thiscall sub_403C00(CacheStore *this, char *a2)
{
  char *buffer; // eax
  char i; // bl
  char v5; // al
  char *v6; // eax
  char *v7; // edx
  char *v8; // ecx
  char *v9; // eax
  char *v10; // eax
  DWORD FileAttributesA; // eax
  char *v12; // eax
  char v13; // al
  char *v14; // eax
  char *v15; // eax
  char *v16; // eax
  DWORD v17; // eax
  char v18; // al
  char *v19; // edx
  char *v20; // ecx
  char *v21; // eax
  char *v22; // eax
  char *v23; // edx
  char *v24; // ecx
  char *v25; // eax
  char v26; // [esp+13h] [ebp-41h]
  DWORD SectorsPerCluster; // [esp+14h] [ebp-40h] BYREF
  DWORD BytesPerSector; // [esp+18h] [ebp-3Ch] BYREF
  DWORD NumberOfFreeClusters; // [esp+1Ch] [ebp-38h] BYREF
  DWORD TotalNumberOfClusters; // [esp+20h] [ebp-34h] BYREF
  FancyStr lpFileName; // [esp+24h] [ebp-30h] BYREF
  FancyStr lpRootPathName; // [esp+30h] [ebp-24h] BYREF
  FancyStr v33; // [esp+3Ch] [ebp-18h] BYREF
  int v34; // [esp+50h] [ebp-4h]

  FancyStrCtor(&lpRootPathName);
  v34 = 0;
  FancyStrCtor(&lpFileName);
  LOBYTE(v34) = 1;
  FancyStrCtor(&v33);
  LOBYTE(v34) = 2;
  v26 = 0;
  if ( a2 && strlen(a2) > 2 )
  {
    buffer = a2;
  }
  else if ( this->strBufferUnused.len < 1 || (buffer = this->strBufferUnused.buffer) == 0 )
  {
    buffer = emptyString;
  }
  FancyStrFromCStr(&v33, buffer);
  for ( i = 'C'; i <= 'Z'; ++i )
  {
    if ( i == 'C' )
    {
      v5 = 'D';
    }
    else
    {
      v5 = 'C';
      if ( i != 'D' )
        v5 = i;
    }
    FancyStrSetVAStr(&lpRootPathName, "%c:\\", v5);
    if ( lpRootPathName.len < 1 || (v6 = lpRootPathName.buffer) == 0 )
      v6 = emptyString;
    if ( GetDriveTypeA(v6) == 3 )
    {
      if ( v33.len < 1 || (v7 = v33.buffer) == 0 )
        v7 = emptyString;
      if ( this->strPath.len < 1 || (v8 = this->strPath.buffer) == 0 )
        v8 = emptyString;
      if ( lpRootPathName.len < 1 || (v9 = lpRootPathName.buffer) == 0 )
        v9 = emptyString;
      FancyStrSetVAStr(&lpFileName, "%s%s%s\\", v9, v8, v7);
      if ( lpFileName.len < 1 || (v10 = lpFileName.buffer) == 0 )
        v10 = emptyString;
      FileAttributesA = GetFileAttributesA(v10);
      if ( FileAttributesA == -1 || (FileAttributesA & 0x10) == 0 )
      {
        if ( lpRootPathName.len < 1 || (v14 = lpRootPathName.buffer) == 0 )
          v14 = emptyString;
        if ( GetDiskFreeSpaceA(v14, &SectorsPerCluster, &BytesPerSector, &NumberOfFreeClusters, &TotalNumberOfClusters)
          && !v26
          && (unsigned int)(unsigned __int64)((double)SectorsPerCluster
                                            * (double)BytesPerSector
                                            * (double)NumberOfFreeClusters
                                            * 0.00000095367431640625) >= 0xC8 )// Free Space >=200MB
        {
          if ( lpFileName.len < 1 || (v15 = lpFileName.buffer) == 0 )
            v15 = emptyString;
          EnsureDirectory(v15);
          if ( lpFileName.len < 1 || (v16 = lpFileName.buffer) == 0 )
            v16 = emptyString;
          v17 = GetFileAttributesA(v16);
          if ( v17 != -1 && (v17 & 0x10) != 0 )
            v26 = i;
        }
      }
      else
      {
        if ( lpFileName.len < 1 || (v12 = lpFileName.buffer) == 0 )
          v12 = emptyString;
        if ( TestWriteToPath(v12) )
        {
          FancyStrSet(&this->strDrive, (const char **)&lpRootPathName.buffer);
          FancyStrSet(&this->strFullPath, (const char **)&lpFileName.buffer);
          FancyStrSet(&this->strSystem, (const char **)&v33.buffer);
          v13 = v26;
          if ( v26 )
          {
            if ( v26 == 'C' )
            {
              v13 = 'D';
            }
            else if ( v26 == 'D' )
            {
              v13 = 'C';
            }
            FancyStrSetVAStr(&lpRootPathName, "%c:\\", v13);
            if ( v33.len < 1 || (v19 = v33.buffer) == 0 )
              v19 = emptyString;
            if ( this->strPath.len < 1 || (v20 = this->strPath.buffer) == 0 )
              v20 = emptyString;
            if ( lpRootPathName.len < 1 || (v21 = lpRootPathName.buffer) == 0 )
              v21 = emptyString;
            FancyStrSetVAStr(&lpFileName, "%s%s%s\\", v21, v20, v19);
            if ( lpFileName.len < 1 || (v22 = lpFileName.buffer) == 0 )
              v22 = emptyString;
            RemoveEmptyDirectoryRecursively(v22);
          }
          goto LABEL_54;
        }
      }
    }
  }
  v18 = v26;
  switch ( v26 )
  {
    case 0:
LABEL_54:
      LOBYTE(v34) = 1;
      FancyStrDtor(&v33);
      LOBYTE(v34) = 0;
      FancyStrDtor(&lpFileName);
      v34 = -1;
      FancyStrDtor(&lpRootPathName);
      return;
    case 67:
      v18 = 68;
      break;
    case 68:
      v18 = 67;
      break;
  }
  FancyStrSetVAStr(&lpRootPathName, "%c:\\", v18);
  if ( v33.len < 1 || (v23 = v33.buffer) == 0 )
    v23 = emptyString;
  if ( this->strPath.len < 1 || (v24 = this->strPath.buffer) == 0 )
    v24 = emptyString;
  if ( lpRootPathName.len < 1 || (v25 = lpRootPathName.buffer) == 0 )
    v25 = emptyString;
  FancyStrSetVAStr(&lpFileName, "%s%s%s\\", v25, v24, v23);
  FancyStrSet(&this->strDrive, (const char **)&lpRootPathName.buffer);
  FancyStrSet(&this->strFullPath, (const char **)&lpFileName.buffer);
  FancyStrSet(&this->strSystem, (const char **)&v33.buffer);
  LOBYTE(v34) = 1;
  FancyStrDtor(&v33);
  LOBYTE(v34) = 0;
  FancyStrDtor(&lpFileName);
  v34 = -1;
  FancyStrDtor(&lpRootPathName);
}

//----- (004040A0) --------------------------------------------------------
int __thiscall InitializeCache(FancyBox *this)
{
  HWND hWnd; // esi
  HWND i; // eax
  FancyStr *v5; // edi
  FancyStr *v6; // esi

  EnsureCache(&fancyBox.field_CE8, "system");
  FancyStrSet(&this->field_2C, (const char **)&fancyBox.field_CE8.strFullPath.buffer);
  if ( this->field_2C.len >= 3 )
  {
    if ( this->strCommandSV.len > 1 )
    {
      FancyStrAppend(&this->field_2C, &this->strCommandSV);
      FancyStrAppendCStr(&this->field_2C, "\\");
    }
    v5 = &this->field_38;
    FancyStrSet(&this->field_38, (const char **)&this->field_2C.buffer);
    FancyStrSet(&this->objsysDllPath, (const char **)&this->field_38.buffer);
    FancyStrAppend(&this->objsysDllPath, &this->strCommandDll);
    v6 = &this->field_50;
    FancyStrSet(v6, (const char **)&v5->buffer);
    FancyStrAppendCStr(v6, aFcrunerExe);
    return 1;
  }
  else
  {
    FancyBoxErrorMessageBox(this, "Can't create cache dir.\r\nMake sure the disk is not full or write-protected.");
    Sleep(0xC8u);
    if ( IsWindow(this->hWnd) )
    {
      hWnd = this->hWnd;
      for ( i = GetParent(hWnd); i; i = GetParent(i) )
        hWnd = i;
      PostMessageA(hWnd, 0x10u, 0, 0);
      return 0;
    }
    else
    {
      PostMessageA(0, 0x10u, 0, 0);
      return 0;
    }
  }
}

//----- (004041A0) --------------------------------------------------------
void __thiscall FancyBoxInitObjsys(FancyBox *this, HINSTANCE a2, HWND hWnd)
{
  HWND v4; // edi
  FancyStr *p_objsysDllPath; // ebp
  int v6; // eax
  char v7; // dl
  char *buffer; // eax
  char *v9; // eax
  char *v10; // eax
  char *v11; // ecx
  bool v12; // cc
  char *v13; // eax
  char *v14; // eax
  char *v15; // eax
  char *v16; // eax
  char *v17; // eax
  char *v18; // eax
  char *v19; // eax
  HWND MostParentWindow; // eax
  int (__cdecl *StdInitFancyBox)(HMODULE, HWND, int, int); // eax
  char *v22; // ebp
  void (__cdecl *StdCmdFancyBox)(int, char *); // eax
  char *v24; // eax
  char *v25; // eax
  char *LastErrorCStr; // [esp-10h] [ebp-148h]
  LONG v27; // [esp-10h] [ebp-148h]
  FancyStr lpFileName; // [esp+4h] [ebp-134h] BYREF
  FancyStr lpExistingFileName; // [esp+10h] [ebp-128h] BYREF
  FancyStr lpPathName; // [esp+1Ch] [ebp-11Ch] BYREF
  char Filename[260]; // [esp+28h] [ebp-110h] BYREF
  int v32; // [esp+134h] [ebp-4h]

  if ( !this->objsysReady )
  {
    this->objsysReady = 1;
    if ( a2 )
      this->hInstance = a2;
    v4 = hWnd;
    if ( hWnd )
    {
      this->hWnd = hWnd;
    }
    else
    {
      hWnd = this->hWnd;
      v4 = hWnd;
    }
    if ( InitializeCache(this) )
    {
      FancyStrCtor(&lpExistingFileName);
      v32 = 0;
      FancyStrCtor(&lpFileName);
      p_objsysDllPath = &this->objsysDllPath;
      LOBYTE(v32) = 1;
      FancyStrSet(&lpExistingFileName, (const char **)&this->objsysDllPath.buffer);
      GetModuleFileNameA(0, Filename, 260u);
      v6 = strlen(Filename);
      if ( Filename[v6] != '\\' )
      {
        do
        {
          if ( v6 <= 0 )
            break;
          v7 = *((_BYTE *)&lpPathName.capacity + v6-- + 3);
        }
        while ( v7 != '\\' );
      }
      Filename[v6] = 0;
      FancyStrFromCStr(&lpFileName, Filename);
      FancyStrAppendCStr(&lpFileName, "\\");
      FancyStrFromCStr(&lpFileName, Filename);
      FancyStrAppendCStr(&lpFileName, "\\");
      FancyStrAppend(&lpFileName, &this->strCommandDll);
      if ( lpFileName.len < 1 || (buffer = lpFileName.buffer) == 0 )
        buffer = emptyString;
      if ( VerifyFileSizeAndTime(buffer, 0, 0) )
        FancyStrSet(&this->objsysDllPath, (const char **)&lpFileName.buffer);
      if ( this->field_68 )
        goto LABEL_68;
      if ( this->objsysDllPath.len < 1 || (v9 = p_objsysDllPath->buffer) == 0 )
        v9 = emptyString;
      if ( !VerifyFileSizeAndTime(v9, 0, 0) )
      {
LABEL_68:
        if ( !FancyBoxUpdateSystem(this, v4) )
          goto LABEL_22;
        FancyStrToLower(&lpExistingFileName);
        FancyStrToLower(&this->objsysDllPath);
        if ( FancyStrNotEquals(&lpExistingFileName, &this->objsysDllPath) )
        {
          if ( this->objsysDllPath.len < 1 || (v10 = p_objsysDllPath->buffer) == 0 )
            v10 = emptyString;
          if ( lpExistingFileName.len < 1 || (v11 = lpExistingFileName.buffer) == 0 )
            v11 = emptyString;
          if ( !CopyFileA(v11, v10, 0) )
          {
LABEL_22:
            FancyBoxErrorMessageBox(this, "Update System err");
LABEL_23:
            LOBYTE(v32) = 0;
            FancyStrDtor(&lpFileName);
            v32 = -1;
            FancyStrDtor(&lpExistingFileName);
            return;
          }
        }
      }
      FancyStrCtor(&lpPathName);
      v12 = this->objsysDllPath.len < 1;
      LOBYTE(v32) = 2;
      if ( v12 || (v13 = p_objsysDllPath->buffer) == 0 )
        v13 = emptyString;
      GetPathAndFilenameFromCstr(&lpPathName, &lpFileName, v13);
      GetCurrentDirectoryA(0x104u, Filename);
      if ( lpPathName.len < 1 || (v14 = lpPathName.buffer) == 0 )
        v14 = emptyString;
      SetCurrentDirectoryA(v14);
      if ( this->objsysDllPath.len < 1 || (v15 = p_objsysDllPath->buffer) == 0 )
        v15 = emptyString;
      this->hObjsys = LoadLibraryA(v15);
      SetCurrentDirectoryA(Filename);
      if ( !this->hObjsys )
      {
        if ( !FancyBoxUpdateSystem(this, hWnd) )
        {
          FancyBoxErrorMessageBox(this, "Update System err");
          this->objsysReady = 0;
          LOBYTE(v32) = 1;
          FancyStrDtor(&lpPathName);
          goto LABEL_23;
        }
        if ( lpPathName.len < 1 || (v16 = lpPathName.buffer) == 0 )
          v16 = emptyString;
        SetCurrentDirectoryA(v16);
        v17 = FancyStrIsEmpty(&this->objsysDllPath);
        this->hObjsys = LoadLibraryA(v17);
        SetCurrentDirectoryA(Filename);
        if ( !this->hObjsys )
        {
          LastErrorCStr = GetLastErrorCStr();
          v18 = FancyStrIsEmpty(&this->objsysDllPath);
          FancyBoxErrorMessageBox(this, "Load %s.\r\n%s", v18, LastErrorCStr);
          this->objsysReady = 0;
          LOBYTE(v32) = 1;
          FancyStrDtor(&lpPathName);
          goto LABEL_23;
        }
      }
      if ( this->strCommandC.len > 2 )
      {
        v19 = this->strCommandC.buffer;
        if ( !v19 )
          v19 = emptyString;
        v27 = (LONG)v19;
        MostParentWindow = GetMostParentWindow(this);
        SetWindowLongA(MostParentWindow, -21, v27);
      }
      StdInitFancyBox = (int (__cdecl *)(HMODULE, HWND, int, int))GetProcAddress(this->hObjsys, "StdInitFancyBox");
      this->fStdInitFancyBox = StdInitFancyBox;
      if ( !StdInitFancyBox )
      {
        if ( this->objsysDllPath.len < 1 || (v22 = p_objsysDllPath->buffer) == 0 )
          v22 = emptyString;
        FancyBoxErrorMessageBox(this, "Seek StdInitFancyBox Err %s!", v22);
        goto LABEL_62;
      }
      StdCmdFancyBox = (void (__cdecl *)(int, char *))GetProcAddress(this->hObjsys, "StdCmdFancyBox");
      this->fStdCmdFancyBox = StdCmdFancyBox;
      if ( !StdCmdFancyBox )
      {
        v24 = FancyStrIsEmpty(&this->objsysDllPath);
        FancyBoxErrorMessageBox(this, "Seek StdCmdFancyBox Err %s!", v24);
LABEL_62:
        this->objsysReady = 0;
        LOBYTE(v32) = 1;
        FancyStrDtor(&lpPathName);
        goto LABEL_23;
      }
      if ( this->fStdInitFancyBox(this->hInstance, hWnd, this->field_74, 100) < 1 )
      {
        FancyBoxErrorMessageBox(this, "Init FacnyBox return err");
        FreeLibrary(this->hObjsys);
        this->fStdCmdFancyBox = 0;
        this->hObjsys = 0;
        goto LABEL_62;
      }
      if ( this->strCommandRaw.len > 3 )
      {
        v25 = FancyStrIsEmpty(&this->strCommandRaw);
        this->fStdCmdFancyBox(0, v25);
      }
      LOBYTE(v32) = 1;
      FancyStrDtor(&lpPathName);
      LOBYTE(v32) = 0;
      FancyStrDtor(&lpFileName);
      v32 = -1;
      FancyStrDtor(&lpExistingFileName);
    }
  }
}
// 404512: conditional instruction was optimized away because eax.4>=3
// 4041A0: using guessed type CHAR Filename[260];

//----- (00404660) --------------------------------------------------------
void __thiscall FancyDownloaderCallbackDtor(FancyDownloaderCallback *this)
{
  IStream *stream; // eax

  this->IBindStatusCallback::lpVtbl = &stru_412584;
  this->FancyDownloaderSubCallback::IHttpNegotiate::lpVtbl = &stru_412570;
  stream = this->stream;
  if ( stream )
    stream->lpVtbl->Release(stream);
  FancyStrDtor(&this->url);
}

//----- (004046C0) --------------------------------------------------------
int __stdcall IBindStatusCallback_AddRef(FancyDownloaderCallback *a1)
{
  int result; // eax

  result = a1->refCount;
  a1->refCount = result + 1;
  return result;
}

//----- (004046D0) --------------------------------------------------------
int __stdcall IBindStatusCallback_QueryInterface(FancyDownloaderCallback *a1, const void *a2, IUnknown **a3)
{
  IUnknown *v3; // ecx

  if ( !memcmp(a2, &CLSID_IUnknown, 0x10u) || !memcmp(a2, &CLSID_IBindStatusCallback, 0x10u) )
  {
    v3 = (IUnknown *)a1;
  }
  else
  {
    if ( memcmp(a2, &CLSID_IHttpNegotiate, 0x10u) )
    {
      *a3 = 0;
      return E_NOINTERFACE;
    }
    if ( a1 )
      v3 = (IUnknown *)&a1->FancyDownloaderSubCallback;
    else
      v3 = 0;
  }
  *a3 = v3;
  if ( !v3 )
    return E_NOINTERFACE;
  v3->lpVtbl->AddRef(v3);
  return 0;
}
// 412684: using guessed type GUID CLSID_IHttpNegotiate;
// 412694: using guessed type GUID CLSID_IBindStatusCallback;
// 4126A4: using guessed type GUID CLSID_IUnknown;

//----- (00404760) --------------------------------------------------------
int __stdcall IHttpNegotiate_BeginningTransaction(int a1, int a2, int a3, int a4, int a5)
{
  return 0;
}

//----- (00404770) --------------------------------------------------------
time_t __cdecl SystemTimeToTime_t(SYSTEMTIME SystemTime)
{
  struct _FILETIME FileTime; // [esp+0h] [ebp-3Ch] BYREF
  struct _SYSTEMTIME v3; // [esp+8h] [ebp-34h] BYREF
  struct tm v4; // [esp+18h] [ebp-24h] BYREF

  if ( !SystemTimeToFileTime(&SystemTime, &FileTime)
    || !FileTimeToLocalFileTime(&FileTime, &FileTime)
    || !FileTimeToSystemTime(&FileTime, &v3) )
  {
    return 0;
  }
  v4.tm_sec = v3.wSecond;
  v4.tm_min = v3.wMinute;
  v4.tm_hour = v3.wHour;
  v4.tm_mday = v3.wDay;
  v4.tm_mon = v3.wMonth - 1;
  v4.tm_year = v3.wYear - 1900;
  v4.tm_isdst = -1;
  return mktime(&v4);
}

//----- (00404810) --------------------------------------------------------
int __stdcall IBindStatusCallback_GetPriority(int a1, int a2)
{
  return E_NOTIMPL;
}

//----- (00404820) --------------------------------------------------------
int __stdcall IBindStatusCallback_GetBindInfo(FancyDownloaderCallback *a1, BINDF *a2, BINDINFO *a3)
{
  *a2 = BINDF_PRAGMA_NO_CACHE|BINDF_PULLDATA|BINDF_GETNEWESTVERSION|BINDF_ASYNCSTORAGE|BINDF_ASYNCHRONOUS;
  a3->cbSize = 84;
  a3->szExtraInfo = 0;
  a3->stgmedData.tymed = 0;
  a3->stgmedData.hBitmap = 0;
  a3->stgmedData.pUnkForRelease = 0;
  a3->grfBindInfoF = 0;
  a3->dwBindVerb = 0;
  a3->szCustomVerb = 0;
  return 0;
}

//----- (00404860) --------------------------------------------------------
int __stdcall IBindStatusCallback_OnObjectAvailable(int a1, int a2, int a3)
{
  return E_NOTIMPL;
}

//----- (00404870) --------------------------------------------------------
FancyDownloader *__thiscall FancyDownloaderCtor(FancyDownloader *this)
{
  FancyStrCtor(&this->netPath);
  FancyStrCtor(&this->localPath);
  FancyStrCtor(&this->filename);
  this->stage = 0;
  this->fUpdateProgress = 0;
  this->callback = 0;
  this->urlMoniker = 0;
  this->bindCtx = 0;
  this->iStream = 0;
  this->field_58 = 0;
  this->contentLength = 0;
  this->lastModified = 0;
  this->field_48 = 0;
  this->completed = 0;
  this->buffer = 0;
  this->capacity = 0;
  this->size = 0;
  this->field_4C = 0;
  return this;
}

//----- (004048F0) --------------------------------------------------------
void __thiscall FancyDownloaderRelease(FancyDownloader *this)
{
  FancyDownloaderCallback *callback; // eax
  IBinding *binding; // eax
  IMoniker *urlMoniker; // eax
  void *buffer; // eax

  callback = this->callback;
  if ( this->callback )
  {
    callback->downloader = 0;
    binding = callback->binding;
    if ( binding )
      binding->lpVtbl->Abort(binding);
  }
  urlMoniker = this->urlMoniker;
  this->callback = 0;
  if ( urlMoniker )
  {
    urlMoniker->lpVtbl->Release(urlMoniker);
    this->urlMoniker = 0;
  }
  buffer = (void *)this->buffer;
  this->urlMoniker = 0;
  this->bindCtx = 0;
  this->iStream = 0;
  if ( buffer )
    j__free(buffer);
  this->buffer = 0;
  this->capacity = 0;
  this->size = 0;
  this->stage = 0;
}

//----- (00404950) --------------------------------------------------------
void __thiscall FancyDownloaderAppendBuffer(FancyDownloader *this, const void *a2, unsigned int a3)
{
  unsigned int v3; // esi
  int v5; // eax
  void *v6; // eax
  int v7; // ebp

  v3 = a3;
  dword_4171B8 += a3;
  v5 = a3 + this->size;
  if ( v5 >= this->capacity )
  {
    this->capacity = v5 + 0x2000;
    v6 = operator new(v5 + 0x2000);
    v7 = (int)v6;
    if ( this->size > 0 )
    {
      qmemcpy(v6, (const void *)this->buffer, this->size);
      v3 = a3;
    }
    j__free((void *)this->buffer);
    this->buffer = v7;
  }
  qmemcpy((void *)(this->size + this->buffer), a2, v3);
  this->size += a3;
}
// 4171B8: using guessed type int dword_4171B8;

//----- (004049F0) --------------------------------------------------------
bool __thiscall FancyDownloaderHasCompleted(FancyDownloader *this, int contentLength, unsigned int lastModified)
{
  int v3; // eax

  v3 = this->contentLength;
  if ( v3 > 0 && v3 == contentLength && lastModified / 0x3C == this->lastModified / 0x3Cu )
  {
    this->completed = 1;
    return 0;
  }
  else
  {
    this->contentLength = contentLength;
    this->lastModified = lastModified;
    return 1;
  }
}

//----- (00404A40) --------------------------------------------------------
int __thiscall FancyDownloaderWriteToFile(FancyDownloader *this)
{
  int size; // ebx
  const void *buffer; // ebp
  int len; // eax
  FancyStr *p_localPath; // edi
  char *v7; // eax
  char *v8; // eax
  int v9; // eax
  char *v10; // eax
  int v11; // [esp-10h] [ebp-34h]
  FancyBoxFile v12; // [esp+4h] [ebp-20h] BYREF
  int v13; // [esp+20h] [ebp-4h]

  if ( this->completed )
    return 1;
  size = this->size;
  buffer = (const void *)this->buffer;
  if ( size > 0 && size == this->contentLength )
  {
    FancyBoxFileInitialize(&v12);
    len = this->localPath.len;
    p_localPath = &this->localPath;
    v13 = 0;
    if ( len < 1 || (v7 = p_localPath->buffer) == 0 )
      v7 = emptyString;
    FancyBoxChangeAndCreateDirectory(v7);
    if ( this->localPath.len < 1 || (v8 = p_localPath->buffer) == 0 )
      v8 = emptyString;
    if ( !FancyBoxFileOpen(&v12, v8, 1u) )
    {
      this->field_4C = 2;
      v13 = -1;
      goto LABEL_14;
    }
    if ( FancyBoxFileWrite(&v12, buffer, size) != size )
    {
      this->field_4C = 2;
      FancyBoxFileClose(&v12);
      v13 = -1;
LABEL_14:
      FancyBoxFileDtor(&v12);
      return 0;
    }
    FancyBoxFileClose(&v12);
    v9 = this->field_48;
    if ( v9 )
      this->lastModified = v9;
    if ( this->lastModified )
    {
      v11 = this->lastModified;
      v10 = FancyStrIsEmpty(&this->localPath);
      if ( !FancySetFileTime(v10, v11) )
        this->field_4C = 3;
    }
    v13 = -1;
    FancyBoxFileDtor(&v12);
    return 1;
  }
  else
  {
    this->field_4C = 1;
    return 0;
  }
}

//----- (00404BC0) --------------------------------------------------------
int processWindowsMessages()
{
  struct tagMSG Msg; // [esp+10h] [ebp-1Ch] BYREF

  if ( !PeekMessageA(&Msg, 0, 0, 0, 0) )
    return 1;
  while ( GetMessageA(&Msg, 0, 0, 0) )
  {
    TranslateMessage(&Msg);
    DispatchMessageA(&Msg);
    if ( !PeekMessageA(&Msg, 0, 0, 0, 0) )
      return 1;
  }
  return 0;
}

//----- (00404C40) --------------------------------------------------------
int __stdcall IHttpNegotiate_QueryInterface(int a1, const void *a2, IUnknown **a3)
{
  return IBindStatusCallback_QueryInterface((FancyDownloaderCallback *)(a1 - 4), a2, a3);
}

//----- (00404C50) --------------------------------------------------------
int __stdcall IHttpNegotiate_AddRef(int a1)
{
  return IBindStatusCallback_AddRef((FancyDownloaderCallback *)(a1 - 4));
}

//----- (00404C60) --------------------------------------------------------
int __stdcall IBindStatusCallback_Release(FancyDownloaderCallback *a1)
{
  int result; // eax
  bool v2; // cf

  result = a1->refCount - 1;
  v2 = a1->refCount == 1;
  a1->refCount = result;
  if ( v2 )
  {
    FancyDownloaderCallbackDtor(a1);
    j__free(a1);
    return 0;
  }
  return result;
}

//----- (00404C90) --------------------------------------------------------
int __stdcall IHttpNegotiate_OnResponse(FancyDownloaderSubCallback *a1, DWORD a2, int a3, int a4, int a5)
{
  FancyDownloaderSubCallback *v6; // esi
  IBinding *binding; // eax
  unsigned int lastModified; // eax
  FancyDownloader *downloader; // ecx
  int contentLength; // [esp+3Ch] [ebp-14h] BYREF
  SYSTEMTIME SystemTime; // [esp+40h] [ebp-10h] BYREF
  DWORD v12; // [esp+54h] [ebp+4h] FORCED BYREF
  IWinInetHttpInfo *v13; // [esp+58h] [ebp+8h] FORCED BYREF

  if ( a2 == 200 )
  {
    v6 = a1;
    binding = a1->binding;
    v13 = 0;
    if ( binding->lpVtbl->QueryInterface(binding, &CLSID_IWinInetHttpInfo, (void **)&v13) >= 0 )
    {
      contentLength = 0;
      v12 = 4;
      v13->lpVtbl->QueryInfo(v13, 0x20000005, &contentLength, &v12, 0, 0);// HTTP_QUERY_CONTENT_LENGTH | HTTP_QUERY_FLAG_NUMBER
      v12 = 16;
      if ( !v13->lpVtbl->QueryInfo(v13, 0x4000000B, &SystemTime, &v12, 0, 0) )// HTTP_QUERY_LAST_MODIFIED | HTTP_QUERY_FLAG_SYSTEMTIME
      {
        lastModified = SystemTimeToTime_t(SystemTime);
        downloader = v6->downloader;
        if ( downloader )
        {
          if ( !FancyDownloaderHasCompleted(downloader, contentLength, lastModified) )
          {
            v6->completed = 1;
            v6->binding->lpVtbl->Abort(v6->binding);
          }
        }
      }
    }
    if ( v13 )
      v13->lpVtbl->Release(v13);
    return 0;
  }
  else
  {
    a1->binding->lpVtbl->Abort(a1->binding);
    return 0;
  }
}
// 412674: using guessed type GUID CLSID_IWinInetHttpInfo;

//----- (00404DA0) --------------------------------------------------------
int __stdcall IBindStatusCallback_OnStartBinding(FancyDownloaderCallback *a1, int a2, IBinding *a3)
{
  FancyDownloader *field_14; // esi
  void *buffer; // eax

  if ( a3 )
  {
    a1->binding = a3;
    a3->lpVtbl->AddRef(a3);
  }
  field_14 = a1->downloader;
  if ( field_14 )
  {
    buffer = (void *)field_14->buffer;
    field_14->field_58 = 10;
    if ( buffer )
      j__free(buffer);
    field_14->capacity = 0x2000;
    field_14->buffer = (int)operator new(0x2000u);
    field_14->size = 0;
    field_14->stage = 2;
  }
  return 0;
}

//----- (00404E00) --------------------------------------------------------
int __stdcall IBindStatusCallback_OnProgress(FancyDownloaderCallback *a1, int a2, unsigned int a3, int a4, int a5)
{
  FancyDownloader *field_14; // ecx
  int (__cdecl *sub_402230)(int, unsigned int); // eax
  char *buffer; // ecx

  field_14 = a1->downloader;
  if ( !field_14 )
    return 0;
  if ( a3 < 2 )
    return 0;
  field_14->field_58 = (a2 << 10) / a3;
  sub_402230 = field_14->fUpdateProgress;
  if ( sub_402230 )
  {
    if ( field_14->filename.len < 1 || (buffer = field_14->filename.buffer) == 0 )
      buffer = emptyString;
    ((void (__cdecl *)(int, unsigned int, char *))sub_402230)(a2, a3, buffer);
  }
  return 0;
}

//----- (00404E60) --------------------------------------------------------
int __stdcall IBindStatusCallback_OnDataAvailable(
        FancyDownloaderCallback *a1,
        unsigned int a2,
        int a3,
        int a4,
        STGMEDIUM *a5)
{
  IStream *pstm; // eax
  IStream *stream; // eax
  int v7; // esi
  FancyDownloader *field_14; // ecx

  if ( (a2 & 1) != 0 && !a1->stream && a5->tymed == TYMED_ISTREAM )
  {
    pstm = a5->pstm;
    a1->stream = pstm;
    pstm->lpVtbl->AddRef(pstm);
  }
  do
  {
    stream = a1->stream;
    a2 = 0;
    v7 = stream->lpVtbl->Read(stream, byte_4171C0, 4092, &a2);
    if ( a2 )
    {
      field_14 = a1->downloader;
      if ( field_14 )
        FancyDownloaderAppendBuffer(field_14, byte_4171C0, a2);
    }
    if ( v7 == (unsigned int)E_PENDING )
      break;
    if ( v7 == 1 )
      return 0;
  }
  while ( v7 >= 0 );
  if ( v7 != (unsigned int)E_PENDING )
    return v7;
  return 0;
}
// 404EE0: conditional instruction was optimized away because esi.4<0

//----- (00404F00) --------------------------------------------------------
void __thiscall FancyDownloaderDtor(FancyDownloader *this)
{
  FancyDownloaderRelease(this);
  this->contentLength = 0;
  this->lastModified = 0;
  this->field_48 = 0;
  FancyStrDtor(&this->filename);
  FancyStrDtor(&this->localPath);
  FancyStrDtor(&this->netPath);
}

//----- (00404F70) --------------------------------------------------------
int __stdcall IHttpNegotiate_Release(FancyDownloaderCallback *a1)
{
  return IBindStatusCallback_Release((FancyDownloaderCallback *)((char *)a1 - 4));
}

//----- (00404F80) --------------------------------------------------------
int __stdcall IBindStatusCallback_OnStopBinding(FancyDownloaderCallback *a1, int a2, int a3)
{
  IBinding *binding; // eax
  FancyDownloader *downloader; // edi
  int completed; // eax

  binding = a1->binding;
  if ( binding )
    binding->lpVtbl->Release(a1->binding);
  downloader = a1->downloader;
  a1->binding = 0;
  if ( downloader )
  {
    if ( a2 )
    {
      completed = a1->completed;
      downloader->field_58 = 1024;
      if ( !completed )
      {
        downloader->stage = 3;
        goto LABEL_9;
      }
    }
    else
    {
      downloader->field_58 = 1024;
    }
    downloader->stage = (FancyDownloaderWriteToFile(downloader) != 0) + 3;
LABEL_9:
    a1->downloader->callback = 0;
    FancyDownloaderCallbackDtor(a1);
    j__free(a1);
  }
  return 0;
}

//----- (00405000) --------------------------------------------------------
void __thiscall FancyDownloaderOpen(FancyDownloader *this)
{
  FancyDownloaderCallback *v2; // eax MAPDST
  FancyStr *p_netPath; // edi
  char *buffer; // eax
  char *v6; // eax
  char *v7; // eax
  char *v8; // eax
  IMoniker *urlMoniker; // eax
  IBindCtx *bindCtx; // eax
  IStream *iStream; // eax
  FancyStr lpMultiByteStr; // [esp+14h] [ebp-201Ch] BYREF
  WCHAR WideCharStr[4096]; // [esp+24h] [ebp-200Ch] BYREF
  int v15; // [esp+202Ch] [ebp-4h]

  FancyDownloaderRelease(this);
  FancyStrCtor(&lpMultiByteStr);
  v15 = 0;
  v2 = (FancyDownloaderCallback *)operator new(0x28u);
  LOBYTE(v15) = 1;
  if ( v2 )
  {
    v2->IBindStatusCallback::lpVtbl = &stru_412584;
    v2->FancyDownloaderSubCallback::IHttpNegotiate::lpVtbl = &stru_412570;
    FancyStrCtor(&v2->url);
    v2->binding = 0;
    v2->stream = 0;
    v2->refCount = 0;
    v2->downloader = this;
    v2->completed = 0;
  }
  else
  {
    v2 = 0;
  }
  LOBYTE(v15) = 0;
  this->callback = v2;
  if ( !v2 )
    goto LABEL_18;
  p_netPath = &this->netPath;
  if ( this->netPath.len < 1 || (buffer = p_netPath->buffer) == 0 )
    buffer = emptyString;
  GetPathAndFilenameFromCstr(&lpMultiByteStr, &this->filename, buffer);
  FancyStrSet(&lpMultiByteStr, (const char **)&this->netPath.buffer);
  FancyStrReplace(&lpMultiByteStr, "\\", "/");
  if ( lpMultiByteStr.len < 1 || (v6 = lpMultiByteStr.buffer) == 0 )
    v6 = emptyString;
  v7 = TrimPath(v6);
  FancyStrFromCStr(&lpMultiByteStr, v7);
  if ( FancyStrStartsWith(&lpMultiByteStr, "www.") )
    FancyStrInsertCStrAt(&lpMultiByteStr, 0, "http://");
  FancyStrSet(&this->callback->url, (const char **)&lpMultiByteStr.buffer);
  if ( lpMultiByteStr.len < 1 || (v8 = lpMultiByteStr.buffer) == 0 )
    v8 = emptyString;
  MultiByteToWideChar(0, 0, v8, -1, WideCharStr, 0x2000);
  if ( CreateURLMoniker(0, WideCharStr, &this->urlMoniker) >= 0
    && CreateAsyncBindCtx(0, this->callback, 0, &this->bindCtx) >= 0 )
  {
    this->urlMoniker->lpVtbl->BindToStorage(this->urlMoniker, this->bindCtx, 0, &CLSID_IStream, (void **)&this->iStream);
    this->stage = 1;
    v15 = -1;
    FancyStrDtor(&lpMultiByteStr);
  }
  else
  {
LABEL_18:
    j__free(this->callback);
    urlMoniker = this->urlMoniker;
    this->callback = 0;
    if ( urlMoniker )
    {
      urlMoniker->lpVtbl->Release(urlMoniker);
      this->urlMoniker = 0;
    }
    bindCtx = this->bindCtx;
    if ( bindCtx )
    {
      bindCtx->lpVtbl->Release(this->bindCtx);
      this->bindCtx = 0;
    }
    iStream = this->iStream;
    if ( iStream )
    {
      iStream->lpVtbl->Release(this->iStream);
      this->iStream = 0;
    }
    v15 = -1;
    FancyStrDtor(&lpMultiByteStr);
  }
}

//----- (00405230) --------------------------------------------------------
BOOL __cdecl sub_405230(char *a1, char *a2, int a3, int a4, void (__cdecl *a5)(int, unsigned int))
{
  BOOL v5; // esi
  FancyDownloader v7; // [esp+4h] [ebp-6Ch] BYREF
  int v8; // [esp+6Ch] [ebp-4h]

  FancyDownloaderCtor(&v7);
  v8 = 0;
  FancyStrFromCStr(&v7.netPath, a1);
  FancyStrFromCStr(&v7.localPath, a2);
  v7.fUpdateProgress = a5;
  v7.field_48 = a3;
  v7.size = a4;
  FancyDownloaderOpen(&v7);
  if ( v7.stage <= 2 )
  {
    do
      Sleep(6u);
    while ( processWindowsMessages() && v7.stage <= 2 );
  }
  v5 = v7.stage == 4;
  v8 = -1;
  FancyDownloaderDtor(&v7);
  return v5;
}

//----- (00405320) --------------------------------------------------------
FancyBoxFileContent *__cdecl pfnopen(const char *pszFile)
{
  FancyBoxFileContent *result; // eax

  if ( strcmp(pszFile, "cab") )
    return 0;
  result = dword_4181CC;
  dword_4181CC->readSize = 0;
  return result;
}

//----- (00405350) --------------------------------------------------------
UINT __cdecl pfnread(FancyBoxFileContent *hf, void *pv, UINT cb)
{
  if ( hf )
    return pfnreadInternal(hf, pv, cb);
  else
    return 0;
}

//----- (00405370) --------------------------------------------------------
UINT __cdecl pfnwrite(INT_PTR hf, void *pv, UINT cb)
{
  return pfnwriteInternal(dword_4181D0, pv, cb);
}

//----- (00405390) --------------------------------------------------------
int __cdecl pfnclose()
{
  return 0;
}

//----- (004053A0) --------------------------------------------------------
int __cdecl pfnseek(FancyBoxFileContent *hf, int dist, int seektype)
{
  if ( hf )
    return pfnseekInternal(hf, dist, seektype);
  else
    return 0;
}

//----- (004053C0) --------------------------------------------------------
HFDI __cdecl FDISafeCreate(
        PFNALLOC pfnalloc,
        PFNFREE pfnfree,
        PFNOPEN pfnopen,
        PFNREAD pfnread,
        PFNWRITE pfnwrite,
        PFNCLOSE pfnclose,
        PFNSEEK pfnseek,
        int cpuType,
        PERF perf)
{
  HFDI result; // eax
  BOOL (__cdecl *FDIDestroy)(HFDI); // eax
  HFDI v11; // esi

  result = LoadLibraryA("CABINET");
  hLibModule = (HMODULE)result;
  if ( result )
  {
    FDICreate = (HFDI (__cdecl *)(PFNALLOC, PFNFREE, PFNOPEN, PFNREAD, PFNWRITE, PFNCLOSE, PFNSEEK, int, PERF))GetProcAddress((HMODULE)result, "FDICreate");
    FDICopy = (BOOL (__cdecl *)(HFDI, LPSTR, LPSTR, int, PFNFDINOTIFY, PFNFDIDECRYPT, void *))GetProcAddress(
                                                                                                hLibModule,
                                                                                                "FDICopy");
    FDIIsCabinet = (BOOL (__cdecl *)(HFDI, INT_PTR, PFDICABINETINFO))GetProcAddress(hLibModule, "FDIIsCabinet");
    FDIDestroy = (BOOL (__cdecl *)(HFDI))GetProcAddress(hLibModule, "FDIDestroy");
    ::FDIDestroy = (int (__cdecl *)(_DWORD))FDIDestroy;
    if ( FDICreate && FDICopy && FDIIsCabinet && FDIDestroy )
    {
      v11 = FDICreate(pfnalloc, pfnfree, pfnopen, pfnread, pfnwrite, pfnclose, pfnseek, cpuType, perf);
      if ( !v11 )
        FreeLibrary(hLibModule);
      return v11;
    }
    else
    {
      FreeLibrary(hLibModule);
      return 0;
    }
  }
  return result;
}
// 4181E0: using guessed type int (__cdecl *FDIDestroy)(_DWORD);

//----- (004054A0) --------------------------------------------------------
void __thiscall FDISafeDestroy(void *this)
{
  if ( FDIDestroy )
  {
    if ( FDIDestroy(this) == 1 )
      FreeLibrary(hLibModule);
  }
}
// 4181E0: using guessed type int (__cdecl *FDIDestroy)(_DWORD);

//----- (004054D0) --------------------------------------------------------
FancyCab *__thiscall FancyCabCtor(FancyCab *this)
{
  this->__vftbl = (int)&off_4125F4;
  memset(this->field_C, 0, sizeof(this->field_C));
  memset(this->field_10C, 0, sizeof(this->field_10C));
  memset(this->field_20C, 0, sizeof(this->field_20C));
  this->hFDI = 0;
  this->cabSize = 0;
  this->folders = 0;
  this->files = 0;
  this->filenames = 0;
  this->filenameSize = 0;
  this->field_30C = 1;
  this->field_310 = 1;
  return this;
}
// 4125F4: using guessed type int (__thiscall *off_4125F4)(void *, char);

//----- (00405540) --------------------------------------------------------
void __thiscall FancyCabFree(FancyCab *this)
{
  int v2; // edi
  char **filenames; // [esp-4h] [ebp-10h]

  if ( this->filenames )
  {
    v2 = 0;
    if ( this->files )
    {
      do
      {
        if ( this->filenames[v2] )
          j__free(this->filenames[v2]);
        this->filenames[v2++] = 0;
      }
      while ( v2 < (unsigned __int16)this->files );
    }
    filenames = this->filenames;
    this->files = 0;
    j__free(filenames);
    this->filenames = 0;
    this->filenameSize = 0;
  }
  if ( this->hFDI )
  {
    if ( !FDIDestroy || FDIDestroy(this->hFDI) != 1 )
    {
      this->hFDI = 0;
      return;
    }
    FreeLibrary(hLibModule);
  }
  this->hFDI = 0;
  if ( this != (FancyCab *)-12 )
    memset(this->field_C, 0, sizeof(this->field_C));
  this->cabSize = 0;
  this->folders = 0;
  this->files = 0;
  dword_4181E8 = 0;
}
// 4181E0: using guessed type int (__cdecl *FDIDestroy)(_DWORD);

//----- (00405610) --------------------------------------------------------
void __thiscall pfnfdinotifyCopyFileName(FancyCab *this, const char *a2)
{
  unsigned __int16 files; // ax

  if ( a2 )
  {
    if ( *a2 )
    {
      files = this->files;
      if ( files )
      {
        if ( this->filenameSize < files )
        {
          this->filenames[this->filenameSize] = (char *)operator new(0x100u);
          strcpy(this->filenames[this->filenameSize++], a2);
        }
      }
    }
  }
}

//----- (00405680) --------------------------------------------------------
int __cdecl sub_405680(FDINOTIFICATION *a1)
{
  if ( !dword_4181E8 )
    return 0;
  if ( !dword_4181E8->field_310 )
    return dword_4181D0;
  pfnfdinotifyCopyFileName(dword_4181E8, a1->psz1);
  return 0;
}
// 4181D0: using guessed type int dword_4181D0;

//----- (004056C0) --------------------------------------------------------
INT_PTR __cdecl pfnfdinotify(int fdint, PFDINOTIFICATION pfdin)
{
  INT_PTR result; // eax

  switch ( fdint )
  {
    case fdintCOPY_FILE:
      result = pfnfdinotifyCopyFile(pfdin);
      break;
    case fdintCLOSE_FILE_INFO:
      result = 1;
      break;
    default:
      result = 0;
      break;
  }
  return result;
}

//----- (00405700) --------------------------------------------------------
void __thiscall FancyCabDtor(FancyCab *this)
{
  this->__vftbl = (int)&off_4125F4;
  FancyCabFree(this);
  dword_4181E8 = 0;
}
// 4125F4: using guessed type int (__thiscall *off_4125F4)(void *, char);

//----- (00405720) --------------------------------------------------------
int __thiscall FancyCabExtract(FancyCab *this, int a2)
{
  char *v3; // ebx
  void *v4; // esi
  char *v5; // eax
  char *v6; // ecx
  char v7; // dl
  int v8; // esi
  char v10[7]; // [esp+1h] [ebp-20Bh]
  HFDI hFDI; // [esp+8h] [ebp-204h]
  char v12[256]; // [esp+Ch] [ebp-200h] BYREF
  char v13[256]; // [esp+10Ch] [ebp-100h] BYREF

  v3 = this->field_C;
  if ( this == (FancyCab *)-12 || !*v3 || this == (FancyCab *)-268 || !this->field_10C[0] )
    return 0;
  hFDI = this->hFDI;
  v4 = hFDI;
  if ( !hFDI )
    return 0;
  this->field_310 = a2;
  v5 = strrchr(this->field_C, '\\');
  if ( v5 )
  {
    v6 = v5 + 1;
    do
    {
      v7 = *v6;
      v6[v13 - (v5 + 1)] = *v6;
      ++v6;
    }
    while ( v7 );
    v8 = v5 - (char *)this;
    strncpy(v12, v3, v5 - (char *)this - 11);
    v10[v8] = 0;
    v4 = hFDI;
  }
  else
  {
    strcpy(v13, v3);
    v12[0] = 0;
  }
  if ( !FDICopy || !FDICopy(v4, v13, v12, 0, (PFNFDINOTIFY)pfnfdinotify, 0, 0) )
  {
    FDISafeDestroy(v4);
    return 0;
  }
  return 1;
}
// 405720: using guessed type char var_20B[7];

//----- (00405840) --------------------------------------------------------
FancyCab *__thiscall FancyCabDtor2(FancyCab *this, char a2)
{
  this->__vftbl = (int)&off_4125F4;
  FancyCabFree(this);
  dword_4181E8 = 0;
  if ( (a2 & 1) != 0 )
    j__free(this);
  return this;
}
// 4125F4: using guessed type int (__thiscall *off_4125F4)(void *, char);

//----- (00405870) --------------------------------------------------------
int __thiscall sub_405870(FancyCab *this, FancyBoxFileContent *a2, FancyBoxFileContent *a3)
{
  HFDI hFDI; // edi
  int erfOper; // edx
  BOOL fError; // ecx
  unsigned __int16 cFiles; // ax
  bool v9; // zf
  int cbCabinet; // edx
  char **v11; // eax
  unsigned int v12; // edx
  ERF perf; // [esp+8h] [ebp-24h] BYREF
  FDICABINETINFO pfdici; // [esp+14h] [ebp-18h] BYREF

  dword_4181CC = a2;
  dword_4181D0 = a3;
  if ( !a2 || !a3 )
    return 0;
  if ( this->hFDI )
    FancyCabFree(this);
  dword_4181E8 = this;
  hFDI = FDISafeCreate(
           operator new,
           j_j__free,
           (PFNOPEN)pfnopen,
           (PFNREAD)pfnread,
           pfnwrite,
           (PFNCLOSE)pfnclose,
           (PFNSEEK)pfnseek,
           1,
           &perf);
  if ( !hFDI )
    return 0;
  if ( !FDIIsCabinet || !FDIIsCabinet(hFDI, (INT_PTR)a2, &pfdici) )
  {
    FDISafeDestroy(hFDI);
    return 0;
  }
  erfOper = perf.erfOper;
  fError = perf.fError;
  stru_4181C0.erfType = perf.erfType;
  this->folders = pfdici.cFolders;
  cFiles = pfdici.cFiles;
  v9 = pfdici.cFiles == 0;
  stru_4181C0.erfOper = erfOper;
  cbCabinet = pfdici.cbCabinet;
  this->hFDI = hFDI;
  stru_4181C0.fError = fError;
  *(_DWORD *)this->field_C = 'bac';
  this->cabSize = cbCabinet;
  this->files = cFiles;
  if ( !v9 )
  {
    v11 = (char **)operator new(4 * cFiles);
    v12 = 4 * (unsigned __int16)this->files;
    this->filenames = v11;
    memset(v11, 0, v12);
  }
  strcpy(this->field_10C, "c:\\temp\\");
  FancyCabExtract(this, 1);
  return 1;
}

//----- (004059D0) --------------------------------------------------------
HLOCAL __cdecl sub_4059D0(DWORD a1)
{
  unsigned int v1; // ebp
  HLOCAL v2; // eax MAPDST
  DWORD *v4; // eax
  char *v6; // eax
  char *v7; // eax
  unsigned int v8; // [esp+Ch] [ebp-18h]

  v1 = 2 * wcslen(L"dlg") + 2;
  v8 = 2 * wcslen(L"ARIAL") + 2;
  v2 = LocalAlloc(0x42u, (v8 + v1 + 27) & 0xFFFFFFFC);
  if ( !v2 )
    return 0;
  v4 = (DWORD *)LocalLock(v2);
  if ( !v4 )
  {
    LocalFree(v2);
    return 0;
  }
  *v4 = a1;
  v4[1] = 0;
  v4[2] = 0;
  v4[3] = 0;
  *((_WORD *)v4 + 8) = 0;
  *((_WORD *)v4 + 9) = 0;
  v6 = (char *)v4 + 18;
  *(_WORD *)(v6 + 1) = 0;
  v6 += 4;
  qmemcpy(v6, L"dlg", v1);
  v7 = &v6[v1];
  *(_WORD *)v7 = 11;
  qmemcpy(v7 + 2, L"ARIAL", v8);
  LocalUnlock(v2);
  return v2;
}

//----- (00405AB0) --------------------------------------------------------
FancyBaseDialog *__thiscall sub_405AB0(FancyBaseDialog *this)
{
  FancyBaseDialog *result; // eax

  result = this;
  this->__vftbl = &stru_412618;
  this->hDialog = 0;
  this->hWndParent = 0;
  this->field_8 = 0;
  LOWORD(this->field_14) = 0;
  this->field_4 = 0x80CC0000;
  return result;
}
// 412618: using guessed type FancyBaseDialogVtbl stru_412618;

//----- (00405AE0) --------------------------------------------------------
int __stdcall sub_405AE0(int a1, int a2, int a3, int a4)
{
  return 0;
}

//----- (00405AF0) --------------------------------------------------------
BOOL __stdcall DialogFunc(HWND hWnd, UINT Msg, WPARAM wParam, unsigned int lParam)
{
  FancyUpdateDialog *v1; // ecx

  v1 = (FancyUpdateDialog *)GetWindowLongA(hWnd, -21);
  if ( !v1 )
    return DefWindowProcA(hWnd, Msg, wParam, lParam);
  if ( Msg == 2 )
  {
    v1->__vftbl->Release((_DWORD *)v1);
    PostQuitMessage(0);
    return 0;
  }
  else if ( Msg == 5 )
  {
    ((void (__thiscall *)(FancyUpdateDialog *, _DWORD, unsigned int))v1->__vftbl->nullsub)(
      v1,
      (unsigned __int16)lParam,
      HIWORD(lParam));
    return 0;
  }
  else
  {
    return ((int (__thiscall *)(FancyUpdateDialog *, HWND, UINT, WPARAM, unsigned int))v1->__vftbl->OnMessage)(
             v1,
             hWnd,
             Msg,
             wParam,
             lParam);
  }
}

//----- (00405B70) --------------------------------------------------------
char *FormatErrorMessage()
{
  DWORD LastError; // eax
  char *v1; // esi
  char *v2; // eax
  char *v3; // edx
  char v4; // cl
  CHAR Buffer[4]; // [esp+0h] [ebp-4h] BYREF

  LastError = GetLastError();
  if ( FormatMessageA(0x1300u, 0, LastError, 0x400u, Buffer, 0, 0) )
  {
    v1 = *(char **)Buffer;
    v2 = *(char **)Buffer;
    v3 = &byte_4181F0[-*(_DWORD *)Buffer];
    do
    {
      v4 = *v2;
      v2[(_DWORD)v3] = *v2;
      ++v2;
    }
    while ( v4 );
    LocalFree(v1);
    return byte_4181F0;
  }
  else
  {
    byte_4181F0[0] = 0;
    return byte_4181F0;
  }
}

//----- (00405BD0) --------------------------------------------------------
void __thiscall FancyUpdateDialogCreateInternal(FancyUpdateDialog *this, HINSTANCE hInstance, HWND hWndParent)
{
  unsigned __int16 v4; // ax
  HWND hDialog; // eax
  HLOCAL v6; // eax
  char *v7; // eax
  const DLGTEMPLATE *v8; // [esp-10h] [ebp-18h]

  v4 = this->field_14;
  this->hWndParent = hWndParent;
  if ( v4 )
  {
    hDialog = CreateDialogParamA(hInstance, (LPCSTR)v4, hWndParent, (DLGPROC)DialogFunc, 0);
  }
  else
  {
    v6 = sub_4059D0(this->field_4);
    this->field_8 = (int)v6;
    v8 = (const DLGTEMPLATE *)LocalLock(v6);
    hDialog = CreateDialogIndirectParamA(hInstance, v8, hWndParent, (DLGPROC)DialogFunc, 0);
  }
  this->hDialog = hDialog;
  if ( hDialog )
  {
    SetWindowLongA(hDialog, -21, (LONG)this);
    ((void (__thiscall *)(FancyUpdateDialog *))this->__vftbl->InitialzeComponent)(this);
  }
  else
  {
    v7 = FormatErrorMessage();
    MessageBoxA(this->hWndParent, v7, "dlg create err!", 0);
  }
}

//----- (00405C70) --------------------------------------------------------
int __thiscall sub_405C70(FancyBaseDialog *this)
{
  int result; // eax

  result = 0;
  this->hDialog = 0;
  this->hWndParent = 0;
  return result;
}

//----- (00405C80) --------------------------------------------------------
BOOL __thiscall FancyBoxHideOrDeactiveWindow(FancyBaseDialog *this, int a2)
{
  if ( a2 )
    return ShowWindow(this->hDialog, 4);
  else
    return ShowWindow(this->hDialog, 0);
}

//----- (00405CB0) --------------------------------------------------------
void __thiscall FancyBaseDialogDtor(FancyBaseDialog *this)
{
  HWND hDialog; // eax

  hDialog = this->hDialog;
  this->__vftbl = &stru_412618;
  if ( hDialog )
  {
    SetWindowLongA(hDialog, -21, 0);
    DestroyWindow(this->hDialog);
    this->hDialog = 0;
    this->hWndParent = 0;
  }
  if ( this->field_8 )
  {
    LocalUnlock((HLOCAL)this->field_8);
    LocalFree((HLOCAL)this->field_8);
    this->field_8 = 0;
  }
}
// 412618: using guessed type FancyBaseDialogVtbl stru_412618;

//----- (00405D10) --------------------------------------------------------
FancyBaseDialog *__thiscall FancyBaseDialogRelease(FancyBaseDialog *this, char a2)
{
  FancyBaseDialogDtor(this);
  if ( (a2 & 1) != 0 )
    j__free(this);
  return this;
}

//----- (00405D30) --------------------------------------------------------
void __thiscall FancyUpdateDialogCtor(FancyUpdateDialog *this)
{
  sub_405AB0(this);
  this->downloadingTextControl = 0;
  this->downloadProgressControl = 0;
  this->updateProgressControl = 0;
  this->field_24 = 0;
  this->__vftbl = &stru_41263C;
  LOWORD(this->field_14) = 135;
  this->width = 345;
  this->height = 230;
}
// 41263C: using guessed type FancyBaseDialogVtbl stru_41263C;

//----- (00405D70) --------------------------------------------------------
void __thiscall FancyUpdateDialogRelease(FancyUpdateDialog *this)
{
  this->__vftbl = (int)&stru_41263C;
  FancyBaseDialogDtor(this);
}
// 41263C: using guessed type int (*off_41263C)();

//----- (00405D80) --------------------------------------------------------
int __thiscall FancyUpdateDialogOnMessage(
        FancyUpdateDialog *this,
        HWND hWnd,
        UINT Msg,
        WPARAM wParam,
        unsigned int lParam)
{
  int result; // eax

  if ( Msg == WM_CLOSE )
  {
    this->field_24 = 1;
    return 0;
  }
  if ( Msg != WM_COMMAND )
    return 0;
  result = 1;
  if ( wParam == 1014 )
    this->field_24 = 1;
  return result;
}

//----- (00405DC0) --------------------------------------------------------
void __thiscall FancyUpdateDialogInitAndShow(FancyUpdateDialog *this)
{
  int screenWidth; // ebx
  int screenHeight; // eax
  HWND hDialog; // edx
  LONG bottom; // ecx
  HWND DlgItem; // eax
  HWND v7; // eax
  HWND v8; // eax
  struct tagRECT Rect; // [esp+Ch] [ebp-10h] BYREF

  screenWidth = GetSystemMetrics(16);
  screenHeight = GetSystemMetrics(17);
  MoveWindow(
    this->hDialog,
    (screenWidth - this->width) / 2,
    (screenHeight - this->height) / 2,
    this->width,
    this->height,
    1);
  SetWindowPos(this->hDialog, 0, 0, 2, 1, 1, 3u);
  FancyBoxHideOrDeactiveWindow(this, this->field_28);
  UpdateWindow(this->hDialog);
  GetClientRect(this->hDialog, &Rect);
  hDialog = this->hDialog;
  bottom = Rect.bottom;
  this->width = Rect.right - Rect.left;
  this->height = bottom - Rect.top;
  DlgItem = GetDlgItem(hDialog, 1013);
  this->downloadingTextControl = DlgItem;
  SetWindowTextA(DlgItem, "Update...");
  v7 = GetDlgItem(this->hDialog, 1015);
  this->downloadProgressControl = v7;
  SendMessageA(v7, 0x401u, 0, 0x640000);
  SendMessageA(this->downloadProgressControl, 0x402u, 0x32u, 0);
  v8 = GetDlgItem(this->hDialog, 1012);
  this->updateProgressControl = v8;
  SendMessageA(v8, 0x401u, 0, 0x640000);
  SendMessageA(this->updateProgressControl, 0x402u, 0x32u, 0);
}

//----- (00405F00) --------------------------------------------------------
void __thiscall FancyUpdateDialogCreate(FancyUpdateDialog *this, HINSTANCE hInstance, HWND hWndParent, int a4)
{
  this->field_28 = a4;
  FancyUpdateDialogCreateInternal(this, hInstance, hWndParent);
}

//----- (00405F20) --------------------------------------------------------
BOOL __thiscall FancyBoxHideWindow(FancyBaseDialog *this)
{
  return FancyBoxHideOrDeactiveWindow(this, 0);
}

//----- (00405F30) --------------------------------------------------------
void __thiscall FancyUpdateDialogSetDownloadingText(FancyUpdateDialog *this, LPCSTR lpString, int a3)
{
  SetWindowTextA(this->downloadingTextControl, lpString);
  if ( a3 )
    SendMessageA(this->downloadProgressControl, 0x402u, 0, 0);
}

//----- (00405F70) --------------------------------------------------------
void __thiscall FancyUpdateDialogSetDownloadPercentage(FancyUpdateDialog *this, WPARAM wParam)
{
  SendMessageA(this->downloadProgressControl, PBM_SETPOS, wParam, 0);
}

//----- (00405F90) --------------------------------------------------------
void __thiscall FancyUpdateDialogSetUpdatePercentage(FancyUpdateDialog *this, WPARAM wParam)
{
  SendMessageA(this->updateProgressControl, PBM_SETPOS, wParam, 0);
}

//----- (00405FB0) --------------------------------------------------------
FancyUpdateDialog *__thiscall FancyUpdateDialogDtor(FancyUpdateDialog *this, char a2)
{
  FancyUpdateDialogRelease(this);
  if ( (a2 & 1) != 0 )
    j__free(this);
  return this;
}

//----- (00405FD0) --------------------------------------------------------
char *__cdecl TrimPath(const char *a1)
{
  char *v1; // ebx
  char *i; // esi
  char v3; // al
  char *v4; // ecx
  int v5; // eax
  int v6; // eax
  char v7; // cl
  int v8; // eax
  char v9; // cl
  char v11[260]; // [esp+Ch] [ebp-104h] BYREF

  strcpy(v11, a1);
  strcpy(byte_4185F0, a1);
  v1 = v11;
LABEL_2:
  for ( i = v1; *i; ++i )
  {
    if ( *(_WORD *)i == '..' )
    {
      v3 = i[2];
      if ( v3 == '\\' || v3 == '/' )
      {
        v4 = i - 2;
        v5 = i - 2 - v1;
        if ( v5 >= 1 )
        {
          do
          {
            if ( *v4 == '\\' )
              break;
            if ( *v4 == '/' )
              break;
            --v5;
            --v4;
          }
          while ( v5 > 0 );
          if ( v5 < 1 )
            ++i;
          *v4 = 0;
          v6 = 0;
          do
          {
            v7 = v11[v6];
            byte_4185F0[v6++] = v7;
          }
          while ( v7 );
          strcat(byte_4185F0, i + 2);
          v8 = 0;
          do
          {
            v9 = byte_4185F0[v8];
            v11[v8++] = v9;
          }
          while ( v9 );
        }
        else
        {
          v1 = i + 3;
        }
        goto LABEL_2;
      }
    }
  }
  return byte_4185F0;
}
// 406037: conditional instruction was optimized away because eax.4>=1
// 405FD0: using guessed type char var_104[260];

//----- (004060D0) --------------------------------------------------------
void __thiscall FancyBoxFileInitialize(FancyBoxFile *this)
{
  FancyStrCtor(&this->Filename);
  this->hFile = 0;
  this->bOpened = 0;
}

//----- (004060F0) --------------------------------------------------------
void __cdecl FancyBoxChangeAndCreateDirectory(LPCSTR lpString2)
{
  signed int i; // eax
  char v2; // cl
  char *v3; // eax
  int v4; // ebp
  FancyStr *v5; // edi
  int NextChar; // esi
  int v7; // edi
  FancyStr *v8; // esi
  char *buffer; // eax
  char *v10; // eax
  FancyStr lpPathName; // [esp+4h] [ebp-308h] BYREF
  struct _SECURITY_ATTRIBUTES SecurityAttributes; // [esp+10h] [ebp-2FCh] BYREF
  char String1[260]; // [esp+1Ch] [ebp-2F0h] BYREF
  FancyStr v14; // [esp+120h] [ebp-1ECh] BYREF
  char v15; // [esp+12Ch] [ebp-1E0h] BYREF
  int v16; // [esp+308h] [ebp-4h]

  lstrcpyA(String1, lpString2);
  for ( i = strlen(String1) - 1; i > 2; --i )
  {
    if ( String1[i] == 92 )
      break;
  }
  v2 = String1[i];
  v3 = &String1[i];
  if ( v2 == '\\' )
  {
    *v3 = 0;
    if ( !SetCurrentDirectoryA(String1) )
    {
      v4 = 0;
      FancyStrCtor(&lpPathName);
      v16 = 0;
      vector_constructor((char *)&v14, 0xCu, 40, (void (__thiscall *)(void *))FancyStrCtor, FancyStrDtor);
      LOBYTE(v16) = 1;
      FancyStrFromCStr(&lpPathName, String1);
      if ( lpPathName.len >= 1 )
      {
        v5 = &v14;
        do
        {
          NextChar = FancyStrFindNextChar(&lpPathName, '\\', 0);
          if ( NextChar <= 0 )
          {
            FancyStrSet(v5, (const char **)&lpPathName.buffer);
            if ( lpPathName.buffer )
              j__free(lpPathName.buffer);
            memset(&lpPathName, 0, sizeof(lpPathName));
          }
          else
          {
            FancyStrSet(v5, (const char **)&lpPathName.buffer);
            FancyStrResize(v5, NextChar);
            FancyStrRemove(&lpPathName, 0, NextChar + 1);
          }
          ++v4;
          ++v5;
        }
        while ( lpPathName.len >= 1 );
      }
      FancyStrSet(&lpPathName, (const char **)&v14.buffer);
      if ( v4 > 1 )
      {
        v7 = v4 - 1;
        v8 = (FancyStr *)&v15;
        do
        {
          FancyStrAppendCStr(&lpPathName, "\\");
          FancyStrAppend(&lpPathName, v8);
          if ( lpPathName.len < 1 || (buffer = lpPathName.buffer) == 0 )
            buffer = emptyString;
          if ( !SetCurrentDirectoryA(buffer) )
          {
            SecurityAttributes.nLength = 12;
            SecurityAttributes.lpSecurityDescriptor = 0;
            SecurityAttributes.bInheritHandle = 0;
            if ( lpPathName.len < 1 || (v10 = lpPathName.buffer) == 0 )
              v10 = emptyString;
            CreateDirectoryA(v10, &SecurityAttributes);
          }
          ++v8;
          --v7;
        }
        while ( v7 );
      }
      LOBYTE(v16) = 0;
      vector_destructor(&v14, 0xCu, 40, FancyStrDtor);
      v16 = -1;
      FancyStrDtor(&lpPathName);
    }
  }
}
// 4060F0: using guessed type CHAR String1[260];

//----- (00406310) --------------------------------------------------------
void __thiscall FancyBoxFileClose(FancyBoxFile *this)
{
  if ( this->hFile && this->bOpened )
    CloseHandle(this->hFile);
  this->hFile = 0;
  this->bOpened = 0;
}

//----- (00406340) --------------------------------------------------------
int __thiscall FancyBoxFileRead(FancyBoxFile *this, LPVOID lpBuffer, int nNumberOfBytesToRead)
{
  HANDLE hFile; // eax
  int v4; // esi
  bool v5; // zf
  int result; // eax

  hFile = this->hFile;
  if ( !hFile || !this->bOpened )
    return 0;
  v4 = nNumberOfBytesToRead;
  v5 = !ReadFile(hFile, lpBuffer, nNumberOfBytesToRead, (LPDWORD)&nNumberOfBytesToRead, 0);
  result = nNumberOfBytesToRead;
  if ( v5 && nNumberOfBytesToRead != v4 )
    return 0;
  return result;
}

//----- (00406380) --------------------------------------------------------
int __thiscall FancyBoxFileWrite(FancyBoxFile *this, LPCVOID lpBuffer, int nNumberOfBytesToWrite)
{
  HANDLE hFile; // eax
  int v4; // esi
  bool v5; // zf
  int result; // eax

  hFile = this->hFile;
  if ( !hFile || !this->bOpened )
    return 0;
  v4 = nNumberOfBytesToWrite;
  v5 = !WriteFile(hFile, lpBuffer, nNumberOfBytesToWrite, (LPDWORD)&nNumberOfBytesToWrite, 0);
  result = nNumberOfBytesToWrite;
  if ( v5 && nNumberOfBytesToWrite != v4 )
    return 0;
  return result;
}

//----- (004063C0) --------------------------------------------------------
time_t __thiscall FileTimeToTime_t(FILETIME *lpFileTime)
{
  struct _FILETIME LocalFileTime; // [esp+0h] [ebp-3Ch] BYREF
  struct _SYSTEMTIME SystemTime; // [esp+8h] [ebp-34h] BYREF
  struct tm v4; // [esp+18h] [ebp-24h] BYREF

  if ( !FileTimeToLocalFileTime(lpFileTime, &LocalFileTime) || !FileTimeToSystemTime(&LocalFileTime, &SystemTime) )
    return 0;
  v4.tm_wday = 0;
  v4.tm_yday = 0;
  v4.tm_sec = SystemTime.wSecond;
  v4.tm_min = SystemTime.wMinute;
  v4.tm_hour = SystemTime.wHour;
  v4.tm_mday = SystemTime.wDay;
  v4.tm_mon = SystemTime.wMonth - 1;
  v4.tm_year = SystemTime.wYear - 1900;
  v4.tm_isdst = -1;
  return mktime(&v4);
}

//----- (00406470) --------------------------------------------------------
BOOL __cdecl Time_tToFileTime(time_t a1, LPFILETIME lpFileTime)
{
  WORD *v2; // eax
  struct _FILETIME FileTime; // [esp+0h] [ebp-18h] BYREF
  SYSTEMTIME SystemTime; // [esp+8h] [ebp-10h] BYREF

  v2 = (WORD *)localtime(&a1);
  if ( v2
    && (SystemTime.wYear = v2[10] + 1900,
        SystemTime.wMonth = v2[8] + 1,
        SystemTime.wDay = v2[6],
        SystemTime.wHour = v2[4],
        SystemTime.wMinute = v2[2],
        SystemTime.wSecond = *v2,
        SystemTime.wMilliseconds = 0,
        SystemTimeToFileTime(&SystemTime, &FileTime)) )
  {
    return LocalFileTimeToFileTime(&FileTime, lpFileTime);
  }
  else
  {
    return 0;
  }
}

//----- (00406500) --------------------------------------------------------
BOOL __cdecl FancySetFileTime(LPCSTR lpFileName, time_t a2)
{
  BOOL result; // eax
  HANDLE FileA; // esi
  FILETIME CreationTime; // [esp+0h] [ebp-8h] BYREF

  result = Time_tToFileTime(a2, &CreationTime);
  if ( result )
  {
    FileA = CreateFileA(lpFileName, 0xC0000000, 1u, 0, 3u, 0x80u, 0);
    return FileA != (HANDLE)-1 && SetFileTime(FileA, &CreationTime, &CreationTime, &CreationTime) && CloseHandle(FileA);
  }
  return result;
}

//----- (00406570) --------------------------------------------------------
BOOL __cdecl VerifyFileSizeAndTime(LPCSTR lpFileName, unsigned int filetime, int filesize)
{
  HANDLE FirstFileA; // eax
  BOOL result; // eax
  unsigned int v5; // eax
  unsigned int v6; // eax
  struct _WIN32_FIND_DATAA FindFileData; // [esp+0h] [ebp-140h] BYREF

  FirstFileA = FindFirstFileA(lpFileName, &FindFileData);
  if ( FirstFileA == (HANDLE)-1 )
    return 0;
  FindClose(FirstFileA);
  result = 0;
  if ( filesize <= 0 || filesize == FindFileData.nFileSizeLow - FindFileData.nFileSizeHigh )
  {
    if ( !filetime )
      return 1;
    v5 = FileTimeToTime_t(&FindFileData.ftLastWriteTime);
    v6 = v5 <= filetime ? filetime - v5 : v5 - filetime;
    if ( v6 <= 0x3C )
      return 1;
  }
  return result;
}

//----- (004065F0) --------------------------------------------------------
BOOL __cdecl CompareTime(LPCSTR lpFileName, int a2, int a3, FILETIME *a4)
{
  HANDLE FirstFileA; // eax
  DWORD dwHighDateTime; // edx
  DWORD v7; // ecx
  struct _FILETIME SystemTimeAsFileTime; // [esp+0h] [ebp-148h] BYREF
  struct _WIN32_FIND_DATAA FindFileData; // [esp+8h] [ebp-140h] BYREF

  FirstFileA = FindFirstFileA(lpFileName, &FindFileData);
  if ( FirstFileA == (HANDLE)-1 )
    return 0;
  FindClose(FirstFileA);
  if ( a3 > 0 && a3 != FindFileData.nFileSizeLow - FindFileData.nFileSizeHigh )
    return 0;
  if ( a4 )
  {
    dwHighDateTime = a4->dwHighDateTime;
    SystemTimeAsFileTime.dwLowDateTime = a4->dwLowDateTime;
    SystemTimeAsFileTime.dwHighDateTime = dwHighDateTime;
  }
  else
  {
    GetSystemTimeAsFileTime(&SystemTimeAsFileTime);
  }
  if ( CompareFileTime(&FindFileData.ftLastWriteTime, &SystemTimeAsFileTime) > 0 )
    return 0;
  v7 = (unsigned __int64)(-10000000i64 * a2 + *(_QWORD *)&SystemTimeAsFileTime) >> 32;
  SystemTimeAsFileTime.dwLowDateTime += -10000000 * a2;
  SystemTimeAsFileTime.dwHighDateTime = v7;
  return CompareFileTime(&FindFileData.ftLastWriteTime, &SystemTimeAsFileTime) >= 0;
}

//----- (004066C0) --------------------------------------------------------
time_t __cdecl GetLastWriteTime(LPCSTR lpFileName)
{
  HANDLE FirstFileA; // eax
  struct _WIN32_FIND_DATAA FindFileData; // [esp+0h] [ebp-140h] BYREF

  FirstFileA = FindFirstFileA(lpFileName, &FindFileData);
  if ( FirstFileA == (HANDLE)-1 )
    return 0;
  FindClose(FirstFileA);
  return FileTimeToTime_t(&FindFileData.ftLastWriteTime);
}

//----- (00406700) --------------------------------------------------------
void __thiscall FancyBoxFileContentCtor(FancyBoxFileContent *this)
{
  this->buffer = 0;
  this->fileSize = 0;
  this->readSize = 0;
  this->capacity = 0;
  this->paddingSize = 128;
}

//----- (00406720) --------------------------------------------------------
unsigned int __thiscall pfnreadInternal(FancyBoxFileContent *this, void *a2, unsigned int a3)
{
  unsigned int result; // eax
  int readSize; // edi

  result = a3;
  readSize = this->readSize;
  if ( readSize + a3 > this->fileSize )
    return 0;
  qmemcpy(a2, (const void *)(readSize + this->buffer), a3);
  this->readSize += a3;
  return result;
}

//----- (00406770) --------------------------------------------------------
int __thiscall FancyBoxFileContentRead(FancyBoxFileContent *this, FancyBoxFile *a2)
{
  FancyBoxFile *v3; // ebx
  HANDLE hFile; // eax
  DWORD FileSize; // edi
  HANDLE v6; // eax
  HANDLE v7; // eax
  bool v8; // zf
  DWORD v9; // eax
  DWORD v11; // [esp-4h] [ebp-10h]
  DWORD v12; // [esp+10h] [ebp+4h] FORCED BYREF

  if ( this->buffer && this->capacity )
    j__free((void *)this->buffer);
  v3 = a2;
  this->buffer = 0;
  this->fileSize = 0;
  this->readSize = 0;
  this->capacity = 0;
  hFile = v3->hFile;
  if ( !hFile )
    return 0;
  if ( !v3->bOpened )
    return 0;
  FileSize = GetFileSize(hFile, 0);
  if ( !FileSize )
    return 0;
  v11 = FileSize + this->paddingSize;
  this->capacity = v11;
  this->buffer = (int)operator new(v11);
  v6 = v3->hFile;
  if ( v6 && v3->bOpened )
    SetFilePointer(v6, 0, 0, 0);
  v7 = v3->hFile;
  if ( v7 && v3->bOpened )
  {
    v8 = !ReadFile(v7, (LPVOID)this->buffer, FileSize, &v12, 0);
    v9 = v12;
    if ( !v8 )
      goto LABEL_15;
    if ( v12 == FileSize )
      goto LABEL_18;
  }
  v9 = 0;
LABEL_15:
  if ( v9 != FileSize )
  {
    j__free((void *)this->buffer);
    this->buffer = 0;
    return 0;
  }
LABEL_18:
  this->fileSize = FileSize;
  this->readSize = FileSize;
  return 1;
}

//----- (00406850) --------------------------------------------------------
unsigned int __thiscall pfnwriteInternal(FancyBoxFileContent *this, const void *a2, unsigned int a3)
{
  void *v5; // eax
  unsigned int result; // eax
  int readSize; // eax
  char *v8; // eax
  int v9; // esi
  unsigned int fileSize; // ecx
  unsigned int v11; // edx
  void *buffer; // [esp-8h] [ebp-18h]
  SIZE_T v13; // [esp-4h] [ebp-14h]
  SIZE_T v14; // [esp-4h] [ebp-14h]
  int v15; // [esp+18h] [ebp+8h]

  if ( this->buffer )
  {
    readSize = this->readSize;
    if ( readSize + a3 < this->capacity )
    {
      qmemcpy((void *)(readSize + this->buffer), a2, a3);
      fileSize = this->fileSize;
      v11 = a3 + this->readSize;
      this->readSize = v11;
      if ( v11 > fileSize )
        this->fileSize = v11;
      return a3;
    }
    else
    {
      v14 = this->fileSize + this->paddingSize + a3;
      this->capacity = v14;
      v8 = (char *)operator new(v14);
      qmemcpy(v8, (const void *)this->buffer, this->fileSize);
      v15 = (int)v8;
      qmemcpy(&v8[this->fileSize], a2, a3);
      v9 = a3 + this->readSize;
      buffer = (void *)this->buffer;
      this->readSize = v9;
      this->fileSize = v9;
      j__free(buffer);
      result = a3;
      this->buffer = v15;
    }
  }
  else
  {
    v13 = a3 + this->paddingSize;
    this->capacity = v13;
    v5 = operator new(v13);
    this->buffer = (int)v5;
    qmemcpy(v5, a2, a3);
    this->fileSize = a3;
    this->readSize = a3;
    return a3;
  }
  return result;
}

//----- (00406950) --------------------------------------------------------
BOOL __thiscall FancyBoxFileContentWrite(FancyBoxFileContent *this, FancyBoxFile *a2)
{
  int fileSize; // esi
  HANDLE hFile; // eax
  const void *buffer; // ecx
  bool v7; // zf
  int v8; // eax

  fileSize = this->fileSize;
  if ( !fileSize )
    return 0;
  hFile = a2->hFile;
  buffer = (const void *)this->buffer;
  if ( !hFile
    || !a2->bOpened
    || (v7 = !WriteFile(hFile, buffer, fileSize, (LPDWORD)&a2, 0), v8 = (int)a2, v7) && a2 != (FancyBoxFile *)fileSize )
  {
    v8 = 0;
  }
  return v8 == this->fileSize;
}

//----- (004069B0) --------------------------------------------------------
int __thiscall pfnseekInternal(FancyBoxFileContent *this, int a2, int a3)
{
  int result; // eax

  if ( a3 )
  {
    if ( a3 == 1 )
    {
      result = a2 + this->readSize;
      this->readSize = result;
      return result;
    }
    if ( a3 == 2 )
    {
      result = a2 + this->fileSize;
      this->readSize = result;
      return result;
    }
  }
  else
  {
    this->readSize = a2;
  }
  return this->readSize;
}

//----- (004069F0) --------------------------------------------------------
int __thiscall FancyBoxFileReadStr(FancyBoxFile *this, FancyStr *a2)
{
  HANDLE hFile; // eax
  HANDLE v4; // eax
  int FileSize; // esi
  char *v7; // ebx

  hFile = this->hFile;
  if ( !hFile || !this->bOpened )
    return 0;
  SetFilePointer(hFile, 0, 0, 0);
  v4 = this->hFile;
  if ( !v4 )
    return 0;
  if ( !this->bOpened )
    return 0;
  FileSize = GetFileSize(v4, 0);
  if ( !FileSize )
    return 0;
  v7 = FancyStrAlloc(a2, FileSize + 1);
  if ( FancyBoxFileRead(this, v7, FileSize) != FileSize )
    return 0;
  v7[FileSize] = 0;
  FancyStrShrink(a2);
  return 1;
}

//----- (00406A80) --------------------------------------------------------
void __cdecl GetPathAndFilenameFromCstr(FancyStr *a1, FancyStr *a2, char *a3)
{
  signed int v3; // esi
  char v4; // al
  char v5[2048]; // [esp+8h] [ebp-800h] BYREF

  strcpy(v5, a3);
  v3 = strlen(v5) - 1;
  if ( v3 < 0 )
  {
LABEL_7:
    if ( a1->buffer )
      j__free(a1->buffer);
    a1->buffer = 0;
    a1->len = 0;
    a1->capacity = 0;
    FancyStrFromCStr(a2, a3);
  }
  else
  {
    while ( 1 )
    {
      v4 = v5[v3];
      if ( v4 == '\\' || v4 == '/' )
        break;
      if ( --v3 < 0 )
        goto LABEL_7;
    }
    v5[v3] = 0;
    FancyStrFromCStr(a1, v5);
    FancyStrAppendCStr(a1, "\\");
    FancyStrFromCStr(a2, &v5[v3 + 1]);
  }
}
// 406ACB: conditional instruction was optimized away because esi.4>=0

//----- (00406B50) --------------------------------------------------------
void __thiscall FancyBoxFileClose(FancyBoxFile *this)
{
  if ( this->hFile && this->bOpened )
  {
    CloseHandle(this->hFile);
    this->hFile = 0;
    this->bOpened = 0;
  }
  FancyStrDtor(&this->Filename);
}

//----- (00406B80) --------------------------------------------------------
int __thiscall FancyBoxFileOpen(FancyBoxFile *this, char *a2, unsigned int a3)
{
  FancyStr *p_Filename; // esi
  bool v5; // zf
  DWORD v6; // ebx
  DWORD v7; // ebp
  char *buffer; // eax
  char *v9; // eax
  HANDLE FileA; // eax

  if ( this->hFile && this->bOpened )
    CloseHandle(this->hFile);
  p_Filename = &this->Filename;
  this->hFile = 0;
  this->bOpened = 0;
  FancyStrFromCStr(&this->Filename, a2);
  if ( a3 > 2 )
  {
    v5 = a3 == 4096;
LABEL_11:
    if ( !v5 )
      return 0;
    v6 = 0x40000000;
    goto LABEL_13;
  }
  if ( a3 != 2 )
  {
    if ( !a3 )
    {
      v6 = 0x80000000;
      v7 = 3;
      goto LABEL_17;
    }
    v5 = a3 == 1;
    goto LABEL_11;
  }
  v6 = -1073741824;
LABEL_13:
  v7 = 2;
  if ( this->Filename.len < 1 || (buffer = p_Filename->buffer) == 0 )
    buffer = emptyString;
  FancyBoxChangeAndCreateDirectory(buffer);
LABEL_17:
  if ( this->Filename.len < 1 || (v9 = p_Filename->buffer) == 0 )
    v9 = emptyString;
  FileA = CreateFileA(v9, v6, 1u, 0, v7, 0x80u, 0);
  this->hFile = FileA;
  if ( FileA && FileA != (HANDLE)-1 )
  {
    this->bOpened = 1;
    return 1;
  }
  return 0;
}

//----- (00406C60) --------------------------------------------------------
void __thiscall FancyBoxFileContentDtor(FancyBoxFileContent *this)
{
  if ( this->buffer && this->capacity )
    j__free((void *)this->buffer);
  this->buffer = 0;
  this->fileSize = 0;
  this->readSize = 0;
  this->capacity = 0;
}

//----- (00406CA0) --------------------------------------------------------
int InitialzeHexMap()
{
  int result; // eax
  unsigned __int8 v1; // cl

  result = 0;
  memset(dword_4186F8, 0, sizeof(dword_4186F8));
  do
  {
    if ( result >= 10 )
    {
      dword_4186F8[(unsigned __int8)(result + 'W')] = result;
      v1 = result + '7';
    }
    else
    {
      v1 = result + '0';
    }
    dword_4186F8[v1] = result;
    byte_418AF8[result++] = v1;
  }
  while ( result < 16 );
  return result;
}
// 4186F8: using guessed type int dword_4186F8[256];

//----- (00406CF0) --------------------------------------------------------
// Microsoft VisualC 2-14/net runtime
void __thiscall FancyStrCtor(FancyStr *this)
{
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
}

//----- (00406D00) --------------------------------------------------------
void __thiscall FancyStrSetCStr(FancyStr *this, const char *a2, int a3)
{
  int v3; // edi
  char *v5; // eax
  int v6; // ecx
  unsigned int v7; // edx

  v3 = a3;
  if ( a3 < 0 )
    v3 = 0;
  if ( this->buffer )
    j__free(this->buffer);
  this->capacity = v3 + 8;
  this->buffer = 0;
  this->len = 0;
  v5 = (char *)operator new(v3 + 10);
  this->buffer = v5;
  if ( a2 && v3 > 0 )
  {
    v6 = strlen(a2);
    v7 = v6;
    if ( v6 > 0 )
    {
      if ( v6 >= v3 )
        v7 = v3;
      qmemcpy(v5, a2, v7);
      this->buffer[v7] = 0;
      this->len = v7;
    }
  }
  else
  {
    *v5 = 0;
  }
}

//----- (00406DA0) --------------------------------------------------------
int __thiscall FancyStrFindNextChar(FancyStr *this, char a2, int a3)
{
  int len; // edx
  char *buffer; // edx
  char v5; // cl
  char *v6; // eax

  len = this->len;
  if ( len < 1 || a3 >= len )
    return -1;
  buffer = this->buffer;
  v5 = this->buffer[a3];
  v6 = &buffer[a3];
  if ( !v5 )
    return -1;
  while ( v5 != a2 )
  {
    v5 = *++v6;
    if ( !v5 )
      return -1;
  }
  return v6 - buffer;
}

//----- (00406DF0) --------------------------------------------------------
char *__usercall find_cstr@<eax>(char *result@<eax>, char *a2@<edi>)
{
  char v2; // dl
  int i; // esi
  char *v4; // ecx

  if ( *a2 )
  {
    v2 = *result;
    if ( *result )
    {
      for ( i = result - a2; ; ++i )
      {
        v4 = a2;
        if ( v2 )
          break;
LABEL_8:
        if ( !*v4 )
          return result;
        v2 = *++result;
        if ( !v2 )
          return 0;
      }
      while ( *v4 )
      {
        if ( v4[i] == *v4 )
        {
          if ( (v4++)[i + 1] )
            continue;
        }
        goto LABEL_8;
      }
    }
    else
    {
      return 0;
    }
  }
  return result;
}

//----- (00406E40) --------------------------------------------------------
int __thiscall FancyStrFind(FancyStr *this, char *a2, int start)
{
  int len; // edx
  char *buffer; // esi
  int v6; // eax
  char *cstr; // eax

  len = this->len;
  if ( len < 1 )
    return -1;
  buffer = this->buffer;
  if ( !this->buffer || !a2 )
    return -1;
  v6 = start;
  if ( start < 0 )
    v6 = 0;
  if ( v6 < len && (cstr = find_cstr(&buffer[v6], a2)) != 0 )
    return cstr - buffer;
  else
    return -1;
}

//----- (00406E90) --------------------------------------------------------
signed int __thiscall FancyStrToLower(FancyStr *this)
{
  signed int result; // eax

  result = this->len;
  if ( result >= 1 )
    return CharLowerBuffA(this->buffer, this->len);
  return result;
}

//----- (00406EB0) --------------------------------------------------------
void __thiscall FancyStrInsertCStrAt(FancyStr *this, int a2, const char *a3)
{
  signed int v4; // ebp
  int len; // eax
  int v6; // eax
  char *buffer; // esi
  int v8; // eax
  char *v9; // ecx
  int v10; // eax
  char *v11; // [esp-10h] [ebp-18h]

  if ( a2 >= 0 )
  {
    if ( a3 )
    {
      v4 = strlen(a3);
      if ( v4 >= 1 )
      {
        len = this->len;
        if ( a2 >= len )
          v6 = a2 + v4;
        else
          v6 = v4 + len;
        if ( v6 >= this->capacity )
        {
          buffer = this->buffer;
          v11 = this->buffer;
          this->buffer = 0;
          FancyStrSetCStr(this, v11, v6 + 1);
          if ( buffer )
            j__free(buffer);
        }
        v8 = this->len;
        if ( a2 < v8 )
          memcpy(&this->buffer[v4 + a2], &this->buffer[a2], v8 - a2 + 1);
        qmemcpy(&this->buffer[a2], a3, v4);
        v9 = this->buffer;
        v10 = v4 + this->len;
        this->len = v10;
        v9[v10] = 0;
      }
    }
  }
}

//----- (00406F70) --------------------------------------------------------
void __thiscall FancyStrInsert(FancyStr *this, int a2, char a3)
{
  int len; // eax
  int v5; // eax
  char *buffer; // ebx
  int v7; // eax
  char *v8; // ecx
  int v9; // eax
  char *v10; // [esp-Ch] [ebp-14h]

  if ( a2 >= 0 )
  {
    len = this->len;
    if ( a2 >= len )
      v5 = a2 + 1;
    else
      v5 = len + 1;
    if ( v5 >= this->capacity )
    {
      buffer = this->buffer;
      v10 = this->buffer;
      this->buffer = 0;
      FancyStrSetCStr(this, v10, v5 + 1);
      if ( buffer )
        j__free(buffer);
    }
    v7 = this->len;
    if ( a2 < v7 )
      memcpy(&this->buffer[a2 + 1], &this->buffer[a2], v7 - a2 + 1);
    this->buffer[a2] = a3;
    v8 = this->buffer;
    v9 = this->len + 1;
    this->len = v9;
    v8[v9] = 0;
  }
}

//----- (00406FF0) --------------------------------------------------------
void __thiscall sub_406FF0(FancyStr *this, FancyStr *a2)
{
  FancyStrInsertCStrAt(this, this->len, a2->buffer);
}

//----- (00407010) --------------------------------------------------------
void __thiscall FancyStrAppendCStr(FancyStr *this, const char *a2)
{
  FancyStrInsertCStrAt(this, this->len, a2);
}

//----- (00407030) --------------------------------------------------------
char __thiscall FancyStrCharAt(FancyStr *this, int a2)
{
  if ( a2 >= 0 && a2 < this->len && this->buffer )
    return this->buffer[a2];
  else
    return 0;
}

//----- (00407050) --------------------------------------------------------
BOOL __thiscall FancyStrEquals(FancyStr *this, const char *a2)
{
  return this->buffer && a2 && this->len >= 1 && strcmp(this->buffer, a2) == 0;
}

//----- (004070C0) --------------------------------------------------------
BOOL __thiscall FancyStrNotEquals(FancyStr *this, FancyStr *a2)
{
  int len; // eax

  len = this->len;
  return len < 1 || len != a2->len || strcmp(this->buffer, a2->buffer) != 0;
}

//----- (00407130) --------------------------------------------------------
BOOL __thiscall FancyStrNotEqual(FancyStr *this, const char *a2)
{
  return !FancyStrEquals(this, a2);
}

//----- (00407150) --------------------------------------------------------
void __thiscall FancyStrReplace(FancyStr *this, char *a2, const char *a3)
{
  int v4; // esi
  unsigned int v5; // ebp
  char *v6; // eax
  char *v7; // edx
  int v8; // eax
  unsigned int v9; // esi
  char *cstr; // eax
  int capacity; // edx
  unsigned int v12; // edi
  int v13; // ecx
  char *v14; // eax
  char *i; // eax
  int v16; // [esp+Ch] [ebp-14h]
  int v17; // [esp+10h] [ebp-10h]
  unsigned int v18; // [esp+14h] [ebp-Ch]
  unsigned int v19; // [esp+14h] [ebp-Ch]
  int v20; // [esp+18h] [ebp-8h]
  char *buffer; // [esp+1Ch] [ebp-4h]

  v16 = 0;
  if ( a3 )
  {
    if ( a2 )
    {
      if ( this->len >= 1 )
      {
        v4 = strlen(a2);
        v20 = v4;
        v5 = strlen(a3);
        if ( v4 >= 1 )
        {
          v18 = v4 - v5;
          if ( (int)(v4 - v5) <= 0 )
          {
            if ( (int)(v4 - v5) >= 0 )
            {
              for ( i = find_cstr(this->buffer, a2); i; i = find_cstr(&i[v5], a2) )
              {
                qmemcpy(i, a3, v5);
                ++v16;
              }
            }
            else
            {
              v9 = v5 - v4;
              v19 = v9;
              cstr = find_cstr(this->buffer, a2);
              if ( cstr )
              {
                while ( 1 )
                {
                  capacity = this->capacity;
                  v12 = cstr - this->buffer;
                  buffer = this->buffer;
                  v13 = v9 + this->len;
                  this->len = v13;
                  if ( v13 < capacity )
                  {
                    memcpy(&cstr[v5], &cstr[v20], v13 - v12 - v5);
                  }
                  else
                  {
                    this->capacity = v9 + v13 + 4 * v9 + 8;
                    v14 = (char *)operator new(v9 + v13 + 4 * v9 + 9);
                    this->buffer = v14;
                    qmemcpy(v14, buffer, v12);
                    qmemcpy(&this->buffer[v12 + v5], &buffer[v12 + v20], this->len - v12 - v5);
                    j__free(buffer);
                  }
                  qmemcpy(&this->buffer[v12], a3, v5);
                  this->buffer[this->len] = 0;
                  ++v16;
                  cstr = find_cstr(&this->buffer[v12 + v5], a2);
                  if ( !cstr )
                    break;
                  v9 = v19;
                }
              }
            }
          }
          else
          {
            v6 = find_cstr(this->buffer, a2);
            if ( v6 )
            {
              while ( 1 )
              {
                v17 = v6 - this->buffer;
                qmemcpy(&v6[v5], &v6[v4], this->len - v17 - v4);
                if ( v5 )
                  qmemcpy(v6, a3, v5);
                v7 = this->buffer;
                v8 = this->len - v18;
                this->len = v8;
                v7[v8] = 0;
                ++v16;
                v6 = find_cstr(&this->buffer[v17 + v5], a2);
                if ( !v6 )
                  break;
                v4 = v20;
              }
            }
          }
        }
      }
    }
  }
}

//----- (004073D0) --------------------------------------------------------
void __thiscall FancyStrRemove(FancyStr *this, int index, int size)
{
  int len; // ecx
  int v5; // edx
  char *buffer; // ecx
  int v7; // eax

  if ( index >= 0 )
  {
    len = this->len;
    if ( index < len )
    {
      if ( this->buffer )
      {
        v5 = size;
        if ( index + size >= len )
        {
          if ( index < 1 )
          {
            FancyStrDtor(this);
            return;
          }
          if ( index + size >= len )
            v5 = len - index;
        }
        if ( v5 >= 1 )
        {
          if ( this->len - index - v5 > 0 )
            qmemcpy(&this->buffer[index], &this->buffer[index + v5], this->len - index - v5);
          buffer = this->buffer;
          v7 = this->len - v5;
          this->len = v7;
          buffer[v7] = 0;
        }
      }
    }
  }
}

//----- (00407450) --------------------------------------------------------
int __cdecl Cstr_to_int(char *a1)
{
  char v1; // al
  char v2; // al
  char v3; // dl
  int v4; // eax
  char *v5; // ecx
  int result; // eax
  char v7; // dl
  char *v8; // ecx

  v1 = *a1;
  if ( *a1 == '-' )
  {
    v2 = a1[1];
    if ( v2 < '0' || v2 > '9' )
    {
      v4 = 0;
    }
    else
    {
      v3 = a1[2];
      v4 = v2 - '0';
      v5 = a1 + 2;
      if ( v3 >= '0' )
      {
        while ( v3 <= 57 )
        {
          ++v5;
          v4 = v3 + 10 * v4 - '0';
          v3 = *v5;
          if ( *v5 < '0' )
            return -v4;
        }
      }
    }
    return -v4;
  }
  else if ( v1 < '0' || v1 > '9' )
  {
    return 0;
  }
  else
  {
    v7 = a1[1];
    result = v1 - '0';
    v8 = a1 + 1;
    if ( v7 >= '0' )
    {
      do
      {
        if ( v7 > '9' )
          break;
        ++v8;
        result = v7 + 10 * result - '0';
        v7 = *v8;
      }
      while ( *v8 >= '0' );
    }
  }
  return result;
}

//----- (004074D0) --------------------------------------------------------
int __cdecl sub_4074D0(char *a1)
{
  char *v1; // edx
  unsigned __int8 v2; // cl
  int result; // eax
  int v4; // esi

  v1 = a1;
  v2 = *a1;
  result = 0;
  if ( *a1 )
  {
    do
    {
      v4 = dword_4186F8[v2];
      v2 = v1[1];
      result = v4 + 16 * result;
      ++v1;
    }
    while ( v2 );
  }
  return result;
}
// 4186F8: using guessed type int dword_4186F8[256];

//----- (00407500) --------------------------------------------------------
void __thiscall FancyStrResize(FancyStr *this, int a2)
{
  int v3; // edi
  char *v4; // eax

  if ( this->len <= a2 )
  {
    v3 = a2;
    if ( a2 < 0 )
      v3 = 0;
    if ( this->buffer )
      j__free(this->buffer);
    this->capacity = v3 + 8;
    this->buffer = 0;
    this->len = 0;
    v4 = (char *)operator new(v3 + 10);
    this->buffer = v4;
    *v4 = 0;
  }
  else
  {
    this->buffer[a2] = 0;
    this->len = strlen(this->buffer);
  }
}

//----- (00407570) --------------------------------------------------------
char *__thiscall FancyStrAlloc(FancyStr *this, int a2)
{
  int v2; // edi
  char *v4; // eax

  v2 = a2;
  if ( a2 < 0 )
    v2 = 0;
  if ( this->buffer )
    j__free(this->buffer);
  this->capacity = v2 + 8;
  this->buffer = 0;
  this->len = 0;
  v4 = (char *)operator new(v2 + 10);
  this->buffer = v4;
  *v4 = 0;
  return this->buffer;
}

//----- (004075C0) --------------------------------------------------------
void __thiscall FancyStrShrink(FancyStr *this)
{
  this->len = strlen(this->buffer);
}

//----- (004075E0) --------------------------------------------------------
int __thiscall FancyStrTrimTailChar(FancyStr *this, char a2)
{
  int len; // esi
  char *buffer; // edx

  len = this->len;
  if ( len < 1 )
    return 0;
  buffer = this->buffer;
  if ( !this->buffer || buffer[len - 1] != a2 )
    return 0;
  this->len = len - 1;
  buffer[len - 1] = 0;
  return 1;
}

//----- (00407620) --------------------------------------------------------
BOOL __thiscall FancyStrStartsWith(FancyStr *this, const char *a2)
{
  int v3; // eax
  char v5[60]; // [esp+8h] [ebp-3Ch] BYREF

  v3 = strlen(a2);
  if ( this->len < v3 || v3 >= 0x28 )
    return 0;
  qmemcpy(v5, this->buffer, v3);
  v5[v3] = 0;
  return strcmp(v5, a2) == 0;
}
// 407620: using guessed type char var_3C[60];

//----- (004076C0) --------------------------------------------------------
FancyStr *__thiscall FancyStrSetStr(FancyStr *this, const char **a2)
{
  const char *v3; // edx
  bool v4; // zf

  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
  v3 = *a2;
  v4 = *a2 == 0;
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
  if ( !v4 )
    FancyStrSetCStr(this, v3, strlen(v3));
  return this;
}

//----- (00407700) --------------------------------------------------------
void __thiscall FancyStrCtorFromCStr(FancyStr *this, char *a2)
{
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
  if ( a2 )
    FancyStrSetCStr(this, a2, strlen(a2));
}

//----- (00407740) --------------------------------------------------------
void FancyStrSetVAStr(FancyStr *a1, LPCSTR arg4, ...)
{
  CHAR a2[2048]; // [esp+4h] [ebp-800h] BYREF
  va_list arglist; // [esp+810h] [ebp+Ch] BYREF

  va_start(arglist, arg4);
  wvsprintfA(a2, arg4, arglist);
  if ( a1->buffer )
    j__free(a1->buffer);
  a1->buffer = 0;
  a1->len = 0;
  a1->capacity = 0;
  FancyStrSetCStr(a1, a2, strlen(a2));
}

//----- (004077B0) --------------------------------------------------------
void __thiscall FancyStrSet(FancyStr *this, const char **a2)
{
  const char *v2; // edi

  v2 = *a2;
  if ( this->buffer )
    j__free(this->buffer);
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
  if ( v2 )
    FancyStrSetCStr(this, v2, strlen(v2));
}

//----- (00407800) --------------------------------------------------------
void __thiscall FancyStrFromCStr(FancyStr *this, char *a2)
{
  if ( this->buffer )
    j__free(this->buffer);
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
  if ( a2 )
    FancyStrSetCStr(this, a2, strlen(a2));
}

//----- (00407850) --------------------------------------------------------
int __thiscall FancyStrSubstring(FancyStr *this, FancyStr *a2, char separator, char a4, int a5)
{
  int len; // edx
  int result; // eax
  char *buffer; // edi
  unsigned __int8 v9; // bl
  int v10; // ecx
  signed int v11; // ecx
  int v12; // ecx
  int v13; // ebx
  char v14; // cl
  int v15; // esi
  char v16; // al
  char *v17; // edi
  char *v18; // edi
  int v19; // ecx
  int v20; // eax
  char *v21; // edi
  int v22; // esi
  int v23; // ecx
  char v24; // al
  const char *v25; // edi
  int i; // esi
  char v27; // al
  signed int v28; // ecx
  int v29; // ecx

  len = this->len;
  result = 0;
  if ( len < 1 )
    return result;
  buffer = this->buffer;
  do                                            // remove character before ' '
  {
    v9 = buffer[result];
    if ( v9 > ' ' )
      break;
    ++result;
  }
  while ( result < this->len );
  if ( result )
  {
    v10 = this->len;
    if ( v10 > 0 && buffer )
    {
      if ( result < v10 )
      {
        if ( result >= 1 )
        {
          v11 = v10 - result;
          if ( v11 > 0 )
            qmemcpy(buffer, &buffer[result], v11);
          v12 = this->len - result;
          this->len = v12;
          this->buffer[v12] = 0;
        }
      }
      else
      {
        FancyStrDtor(this);
      }
    }
    len = this->len;
    if ( len < 1 )
      return 0;
  }
  if ( v9 == '\'' || v9 == '"' )
  {
    v22 = 1;
    v23 = 0;
    if ( len > 1 )
    {
      do
      {
        v24 = this->buffer[v22];
        if ( v24 == '\\' && v23 != v22 )
          v23 = v22 + 1;
        if ( v24 == v9 && v23 != v22 )
          break;
        ++v22;
      }
      while ( v22 < this->len );
    }
    this->buffer[v22] = 0;
    v25 = this->buffer + 1;
    if ( a2->buffer )
      j__free(a2->buffer);
    a2->buffer = 0;
    a2->len = 0;
    a2->capacity = 0;
    if ( v25 )
      FancyStrSetCStr(a2, v25, strlen(v25));
    for ( i = v22 + 1; i < this->len; ++i )
    {
      v27 = this->buffer[i];
      if ( v27 == separator )
        break;
      if ( v27 == a4 )
        break;
    }
    v19 = this->len;
    v20 = i + 1;
    if ( v19 <= 0 )
      return 1;
    v21 = this->buffer;
    if ( !this->buffer )
      return 1;
    if ( v20 >= v19 )
      goto LABEL_38;
    goto LABEL_66;
  }
  v13 = 0;
  v14 = separator;
  v15 = 0;
  do
  {
    v16 = this->buffer[v13];
    if ( v16 == '{' && v14 != '{' )
      ++v15;
    if ( v16 == '}' && --v15 >= 0 )
      goto LABEL_30;
    if ( v15 >= 1 )
      goto LABEL_30;
    if ( v16 == v14 || v16 > 0 && v16 < 32 || v16 == a4 )
      break;
    v14 = separator;
LABEL_30:
    ++v13;
  }
  while ( v13 < this->len );
  if ( v13 < len )
  {
    this->buffer[v13] = 0;
    v18 = this->buffer;
    if ( a2->buffer )
      j__free(a2->buffer);
    a2->buffer = 0;
    a2->len = 0;
    a2->capacity = 0;
    if ( v18 )
      FancyStrSetCStr(a2, v18, strlen(v18));
    v19 = this->len;
    v20 = v13 + 1;
    if ( v19 <= 0 )
      return 1;
    v21 = this->buffer;
    if ( !this->buffer )
      return 1;
    if ( v20 >= v19 )
    {
      FancyStrDtor(this);
      return 1;
    }
LABEL_66:
    if ( v20 >= 1 )
    {
      v28 = v19 - v20;
      if ( v28 > 0 )
        qmemcpy(v21, &v21[v20], v28);
      v29 = this->len - v20;
      this->len = v29;
      this->buffer[v29] = 0;
    }
    return 1;
  }
  if ( a5 )
    return 0;
  v17 = this->buffer;
  if ( a2->buffer )
    j__free(a2->buffer);
  a2->buffer = 0;
  a2->len = 0;
  a2->capacity = 0;
  if ( v17 )
    FancyStrSetCStr(a2, v17, strlen(v17));
  if ( this->buffer )
LABEL_38:
    j__free(this->buffer);
  this->buffer = 0;
  this->len = 0;
  this->capacity = 0;
  return 1;
}
// 40786B: conditional instruction was optimized away because edx.4>=1
// 4078F9: conditional instruction was optimized away because edx.4>=1

//----- (00407B20) --------------------------------------------------------
int __thiscall sub_407B20(FancyStr *this, int nDefault, char separator)
{
  char *buffer; // esi
  int v5; // edi
  int v6; // esi
  char *v7; // eax
  FancyStr v8; // [esp+4h] [ebp-18h] BYREF
  int v9; // [esp+18h] [ebp-4h]

  memset(&v8, 0, sizeof(v8));
  v9 = 0;
  if ( FancyStrSubstring(this, &v8, separator, 0, 0) )
  {
    buffer = v8.buffer;
    if ( v8.len > 2 && v8.buffer )
    {
      if ( *v8.buffer == '#' )
      {
        v5 = Cstr_to_int_hex(v8.buffer + 1);
        v9 = -1;
        j__free(buffer);
        return v5;
      }
      if ( *v8.buffer == '0' && v8.buffer[1] == 'x' )
      {
        v6 = Cstr_to_int_hex(v8.buffer + 2);
        v9 = -1;
        FancyStrDtor(&v8);
        return v6;
      }
    }
    if ( v8.len < 1 || (v7 = v8.buffer) == 0 )
      v7 = emptyString;
    v5 = Cstr_to_int(v7);
    v9 = -1;
    if ( buffer )
      j__free(buffer);
    return v5;
  }
  v9 = -1;
  if ( v8.buffer )
    j__free(v8.buffer);
  return nDefault;
}
// 407BA4: conditional instruction was optimized away because %var_14.4>=3
// 407BBC: conditional instruction was optimized away because %var_14.4>=3
// 407BE4: conditional instruction was optimized away because %var_18.4!=0
// 407BEE: conditional instruction was optimized away because %var_14.4>=3
// 407BF9: conditional instruction was optimized away because %var_14.4>=3

//----- (00407C80) --------------------------------------------------------
FancyStr *__thiscall FancyStrSubString(FancyStr *this, FancyStr *a2, int a3, int a4)
{
  int len; // edx
  FancyStr *result; // eax
  int v7; // eax
  int v8; // ecx
  FancyStr *v9; // esi
  int v10; // esi
  char *v11; // ecx
  char v12; // bl
  FancyStr v13; // [esp+Ch] [ebp-18h] BYREF
  int v14; // [esp+20h] [ebp-4h]

  memset(&v13, 0, sizeof(v13));
  len = this->len;
  v14 = 1;
  if ( len >= 1 )
  {
    v7 = a3;
    if ( a3 < 0 )
      v7 = 0;
    v8 = a4;
    if ( a4 == -1 )
      v8 = len - v7;
    if ( v7 + v8 > len )
      v8 = len - v7;
    if ( v8 > 0 )
    {
      v10 = v7 + v8;
      v11 = &this->buffer[v7 + v8];
      v12 = *v11;
      *v11 = 0;
      FancyStrFromCStr(&v13, &this->buffer[v7]);
      this->buffer[v10] = v12;
      v9 = a2;
      FancyStrSetStr(a2, (const char **)&v13.buffer);
      LOBYTE(v14) = 0;
      if ( v13.buffer )
        j__free(v13.buffer);
    }
    else
    {
      v9 = a2;
      FancyStrSetStr(a2, (const char **)&v13.buffer);
    }
    return v9;
  }
  else
  {
    result = a2;
    a2->buffer = 0;
    a2->len = 0;
    a2->capacity = 0;
  }
  return result;
}

//----- (00407D80) --------------------------------------------------------
FancyLinedText *__thiscall FancyLinedTextCtor(FancyLinedText *this)
{
  FancyLinedText *result; // eax

  result = this;
  this->__vftbl = (int)&off_412660;
  this->size = 0;
  this->count = 0;
  this->line = 0;
  return result;
}
// 412660: using guessed type int (__thiscall *off_412660)(void *, char);

//----- (00407DA0) --------------------------------------------------------
void __thiscall FancyLinedTextAddLine(FancyLinedText *this, const char *a2)
{
  int count; // eax
  int v5; // eax
  char **v6; // ebp

  if ( a2 )
  {
    if ( !this->line )
    {
      this->count = 50;
      this->line = (char **)operator new(0xC8u);
    }
    count = this->count;
    if ( this->size >= count - 1 )
    {
      v5 = count + 50;
      this->count = v5;
      v6 = (char **)operator new(4 * v5);
      qmemcpy(v6, this->line, 4 * this->size);
      j__free(this->line);
      this->line = v6;
    }
    this->line[this->size] = (char *)operator new(strlen(a2) + 2);
    strcpy(this->line[this->size++], a2);
  }
}

//----- (00407E70) --------------------------------------------------------
void __thiscall FancyLinedTextClear(FancyLinedText *this)
{
  int i; // edi

  if ( this->line )
  {
    for ( i = 0; i < this->size; ++i )
      j__free(this->line[i]);
    j__free(this->line);
    this->line = 0;
  }
  this->count = 0;
  this->size = 0;
}

//----- (00407EC0) --------------------------------------------------------
char *__thiscall FancyLinedTextGetLine(FancyLinedText *this, int a2)
{
  if ( a2 < 0 || a2 >= this->size )
    return 0;
  else
    return this->line[a2];
}

//----- (00407EE0) --------------------------------------------------------
int __thiscall FancyLinedTextSize(FancyLinedText *this)
{
  return this->size;
}

//----- (00407EF0) --------------------------------------------------------
void __thiscall FancyLinedTextFillFromBuffer(FancyLinedText *this, char *a2)
{
  int v3; // esi
  int v4; // edi
  FancyStr *v5; // eax
  char *buffer; // eax
  FancyStr *v7; // eax
  char *v8; // eax
  FancyStr v9; // [esp+10h] [ebp-30h] BYREF
  FancyStr v10; // [esp+1Ch] [ebp-24h] BYREF
  FancyStr v11; // [esp+28h] [ebp-18h] BYREF
  int v12; // [esp+3Ch] [ebp-4h]

  FancyStrCtorFromCStr(&v10, a2);
  v3 = 0;
  v12 = 0;
  FancyStrCtor(&v9);
  LOBYTE(v12) = 1;
  FancyLinedTextClear(this);
  v4 = FancyStrFind(&v10, "\r\n", 0);
  if ( v4 >= 0 )
  {
    do
    {
      v5 = FancyStrSubString(&v10, &v11, v3, v4 - v3);
      LOBYTE(v12) = 2;
      FancyStrSet(&v9, (const char **)&v5->buffer);
      LOBYTE(v12) = 1;
      FancyStrDtor(&v11);
      if ( v9.len < 1 || (buffer = v9.buffer) == 0 )
        buffer = emptyString;
      FancyLinedTextAddLine(this, buffer);
      v3 = v4 + 2;
      v4 = FancyStrFind(&v10, "\r\n", v4 + 2);
    }
    while ( v4 >= v3 );
  }
  v7 = FancyStrSubString(&v10, &v11, v3, v10.len - v3);
  LOBYTE(v12) = 3;
  FancyStrSet(&v9, (const char **)&v7->buffer);
  LOBYTE(v12) = 1;
  FancyStrDtor(&v11);
  if ( v9.len < 1 || (v8 = v9.buffer) == 0 )
    v8 = emptyString;
  FancyLinedTextAddLine(this, v8);
  LOBYTE(v12) = 0;
  FancyStrDtor(&v9);
  v12 = -1;
  FancyStrDtor(&v10);
}

//----- (00408040) --------------------------------------------------------
void __thiscall FancyLinedTextDtor(FancyLinedText *this)
{
  this->__vftbl = (int)&off_412660;
  FancyLinedTextClear(this);
}
// 412660: using guessed type int (__thiscall *off_412660)(void *, char);

//----- (00408050) --------------------------------------------------------
int __thiscall FancyLinedTextFillFromFile(FancyLinedText *this, FancyBoxFile *a2)
{
  char *buffer; // eax
  FancyStr v5; // [esp+4h] [ebp-18h] BYREF
  int v6; // [esp+18h] [ebp-4h]

  FancyStrCtor(&v5);
  v6 = 0;
  if ( FancyBoxFileReadStr(a2, &v5) )
  {
    if ( v5.len < 1 || (buffer = v5.buffer) == 0 )
      buffer = emptyString;
    FancyLinedTextFillFromBuffer(this, buffer);
    v6 = -1;
    FancyStrDtor(&v5);
    return 1;
  }
  else
  {
    v6 = -1;
    FancyStrDtor(&v5);
    return 0;
  }
}

//----- (00408100) --------------------------------------------------------
int __thiscall FancyLinedTextFillFromPath(FancyLinedText *this, char *a1)
{
  FancyBoxFile v4; // [esp+4h] [ebp-20h] BYREF
  int v5; // [esp+20h] [ebp-4h]

  FancyBoxFileInitialize(&v4);
  v5 = 0;
  if ( FancyBoxFileOpen(&v4, a1, 0) )
  {
    FancyLinedTextFillFromFile(this, &v4);
    FancyBoxFileClose(&v4);
    v5 = -1;
    FancyBoxFileDtor(&v4);
    return 1;
  }
  else
  {
    v5 = -1;
    FancyBoxFileDtor(&v4);
    return 0;
  }
}

//----- (004081B0) --------------------------------------------------------
FancyLinedText *__thiscall FancyLinedTextRelease(FancyLinedText *this, char a2)
{
  this->__vftbl = (int)&off_412660;
  FancyLinedTextClear(this);
  if ( (a2 & 1) != 0 )
    j__free(this);
  return this;
}
// 412660: using guessed type int (__thiscall *off_412660)(void *, char);

//----- (004087B7) --------------------------------------------------------
void __stdcall vector_destructor(char *a1, unsigned int a2, int a3, void (__thiscall *a4)(void *))
{
  char *i; // [esp+30h] [ebp+8h]

  for ( i = &a1[a3 * a2]; --a3 >= 0; a4(i) )
    i -= a2;
}
// 408803: conditional instruction was optimized away because %var_1C.4==1

//----- (00408817) --------------------------------------------------------
void __stdcall vector_constructor(
        char *a1,
        unsigned int a2,
        int a3,
        void (__thiscall *a4)(void *),
        void (__thiscall *a5)(void *))
{
  int i; // [esp+10h] [ebp-1Ch]

  for ( i = 0; i < a3; ++i )
  {
    a4(a1);
    a1 += a2;
  }
}
// 408865: conditional instruction was optimized away because %var_20.4==1

//----- (00411550) --------------------------------------------------------
int sub_411550()
{
  FancyBoxCtor(&fancyBox);
  return atexit(sub_411590);
}

//----- (00411570) --------------------------------------------------------
int sub_411570()
{
  CacheStoreInitialize(&fancyBox.field_CE8);
  return atexit(sub_4115A0);
}

//----- (00411590) --------------------------------------------------------
void __cdecl sub_411590()
{
  FancyStrDtor(&fancyBox.updateMessage);
  FancyStrDtor(&fancyBox.strCommandI);
  FancyStrDtor(&fancyBox.strCommandC);
  FancyStrDtor(&fancyBox.strCommandSV);
  FancyStrDtor(&fancyBox.cmdLine);
  FancyStrDtor(&fancyBox.strCommandSystem);
  FancyStrDtor(&fancyBox.field_50);
  FancyStrDtor(&fancyBox.objsysDllPath);
  FancyStrDtor(&fancyBox.field_38);
  FancyStrDtor(&fancyBox.field_2C);
  FancyStrDtor(&fancyBox.strCommandRaw);
  FancyStrDtor(&fancyBox.strCommandDll);
}

//----- (004115A0) --------------------------------------------------------
void __cdecl sub_4115A0()
{
  FancyStrDtor(&fancyBox.field_CE8.strSystem);
  FancyStrDtor(&fancyBox.field_CE8.strFullPath);
  FancyStrDtor(&fancyBox.field_CE8.strDrive);
  FancyStrDtor(&fancyBox.field_CE8.strBufferUnused);
  FancyStrDtor(&fancyBox.field_CE8.strPath);
}

// nfuncs=384 queued=164 decompiled=164 lumina nreq=0 worse=0 better=0
// ALL OK, 164 function(s) have been successfully decompiled
